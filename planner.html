<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Squad Planner & Tactical Board 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; --grass: #1a2e1a; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .pitch-bg { 
            background: linear-gradient(180deg, #1a3a1a 0%, #0d1a0d 100%);
            border: 3px solid rgba(255,255,255,0.1);
            position: relative;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 10% 10%;
        }
        .pitch-line { position: absolute; border: 1px solid rgba(255,255,255,0.2); pointer-events: none; }
        .center-circle { width: 120px; height: 120px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .player-node { width: 64px; text-align: center; transition: all 0.3s ease; }
        .player-node:hover { transform: translateY(-5px) scale(1.1); z-index: 50; }
        .index-badge { position: absolute; top: -4px; right: -4px; font-size: 9px; font-weight: 900; padding: 1px 4px; border-radius: 4px; border: 1px solid black; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1400px] mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-8 border-b border-white/5 pb-6 gap-4 no-print">
            <div>
                <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter">Elite<span class="text-yellow-500">Squad Planner</span></h1>
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Formatie-analyse Seizoen 2026</p>
            </div>
            <div class="flex gap-3">
                <select id="teamSelect" class="bg-black border border-yellow-700/50 text-yellow-500 text-xs font-black px-6 py-2 rounded-full outline-none cursor-pointer"></select>
                <button id="exportPdf" class="bg-yellow-600 text-black px-6 py-2 rounded-full text-[10px] font-black uppercase shadow-lg hover:bg-yellow-400 transition">Download Squad Report</button>
                <a href="index.html" class="bg-white/5 border border-white/20 text-white px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Dashboard</a>
            </div>
        </header>

        <div id="capturePlanner" class="grid grid-cols-1 xl:grid-cols-12 gap-8 bg-[#0a0a0a] p-6 rounded-[2rem]">
            
            <div class="xl:col-span-8">
                <div class="pitch-bg rounded-[2rem] aspect-[4/3] relative overflow-hidden shadow-2xl p-8">
                    <div class="center-circle absolute"></div>
                    <div class="absolute w-full h-[1px] bg-white/20 top-1/2"></div>
                    <div class="absolute w-40 h-20 border border-white/20 top-0 left-1/2 -translate-x-1/2"></div>
                    <div class="absolute w-40 h-20 border border-white/20 bottom-0 left-1/2 -translate-x-1/2"></div>

                    <div id="tacticalBoard" class="relative w-full h-full flex flex-col justify-between py-4">
                        <div id="FW-Line" class="flex justify-around items-center h-1/4"></div>
                        <div id="MF-Line" class="flex justify-around items-center h-1/4"></div>
                        <div id="DF-Line" class="flex justify-around items-center h-1/4"></div>
                        <div id="GK-Line" class="flex justify-center items-center h-1/4"></div>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-4 space-y-6">
                <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                    <h3 class="text-xs font-black text-yellow-500 uppercase mb-6 tracking-widest border-b border-white/5 pb-2">Linie Bezetting 2026</h3>
                    <div id="analysisContent" class="space-y-6"></div>
                </div>

                <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Wisselspelers / Potentieel</h3>
                    <div id="benchContent" class="grid grid-cols-1 gap-2 max-h-[400px] overflow-y-auto pr-2 text-[10px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        async function init() {
            const allPlayers = await DataProvider.getAllPlayers();
            const teams = [...new Set(allPlayers.map(p => p.bio.team))];
            const select = document.getElementById('teamSelect');
            select.innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join('');

            const calculateAll = (list) => {
                return list.map(p => {
                    const obj = Math.round((p.obj?.attendance * 0.4) + ((p.obj?.minutes / 1500) * 100 * 0.6));
                    const coach = Math.round((Object.values(p.ratings || {}).reduce((a,b)=>parseInt(a)+parseInt(b),0)/(Object.keys(p.ratings || {}).length*5 || 1))*100);
                    const final = Math.round((obj * 0.65) + (p.stats?.Techniek * 0.20 || 10) + (coach * 0.15));
                    return { ...p, finalIndex: final };
                }).sort((a,b) => b.finalIndex - a.finalIndex);
            };

            const render = () => {
                const teamData = calculateAll(allPlayers.filter(p => p.bio.team === select.value));
                const lines = { FW: [], MF: [], DF: [], GK: [], Bench: [] };
                
                // Formatie limieten (4-3-3)
                const limits = { Aanvaller: 3, Middenvelder: 3, Verdediger: 4, Keeper: 1 };
                const counters = { Aanvaller: 0, Middenvelder: 0, Verdediger: 0, Keeper: 0 };

                teamData.forEach(p => {
                    const role = p.bio.role;
                    if (counters[role] < limits[role]) {
                        if (role === 'Aanvaller') lines.FW.push(p);
                        else if (role === 'Middenvelder') lines.MF.push(p);
                        else if (role === 'Verdediger') lines.DF.push(p);
                        else if (role === 'Keeper') lines.GK.push(p);
                        counters[role]++;
                    } else {
                        lines.Bench.push(p);
                    }
                });

                // Render Nodes
                const nodeHtml = (p) => `
                    <div class="player-node relative">
                        <div class="index-badge ${p.finalIndex > 75 ? 'bg-green-500' : p.finalIndex > 60 ? 'bg-yellow-500' : 'bg-red-500'} text-black">${p.finalIndex}</div>
                        <img src="${p.bio.photo}" class="w-14 h-14 rounded-full border-2 border-white/20 mx-auto object-cover bg-black shadow-xl">
                        <p class="text-[9px] font-black uppercase mt-2 text-white truncate">${p.bio.name.split(' ')[0]}</p>
                    </div>
                `;

                document.getElementById('FW-Line').innerHTML = lines.FW.map(nodeHtml).join('');
                document.getElementById('MF-Line').innerHTML = lines.MF.map(nodeHtml).join('');
                document.getElementById('DF-Line').innerHTML = lines.DF.map(nodeHtml).join('');
                document.getElementById('GK-Line').innerHTML = lines.GK.map(nodeHtml).join('');

                // Render Bench
                document.getElementById('benchContent').innerHTML = lines.Bench.map(p => `
                    <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg border border-white/5">
                        <div class="flex items-center gap-3">
                            <img src="${p.bio.photo}" class="w-8 h-8 rounded-full object-cover">
                            <span class="font-bold uppercase">${p.bio.name}</span>
                        </div>
                        <span class="font-black text-yellow-500">${p.finalIndex}%</span>
                    </div>
                `).join('');

                // Render Analysis
                const renderAnalysisLine = (label, current, max) => {
                    const avg = current.length ? Math.round(current.reduce((a,b)=>a+b.finalIndex,0)/current.length) : 0;
                    const color = avg > 75 ? 'text-green-500' : (avg > 60 ? 'text-yellow-500' : 'text-red-500');
                    return `
                        <div>
                            <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                                <span class="text-gray-400">${label} (${current.length}/${max})</span>
                                <span class="${color}">${avg}% Avg</span>
                            </div>
                            <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-500" style="width: ${avg}%"></div>
                            </div>
                        </div>
                    `;
                };

                document.getElementById('analysisContent').innerHTML = 
                    renderAnalysisLine('Aanval', lines.FW, 3) +
                    renderAnalysisLine('Middenveld', lines.MF, 3) +
                    renderAnalysisLine('Verdediging', lines.DF, 4) +
                    renderAnalysisLine('Keepers', lines.GK, 1);
            };

            select.addEventListener('change', render);
            document.getElementById('exportPdf').addEventListener('click', async () => {
                const canvas = await html2canvas(document.getElementById('capturePlanner'), { scale: 2, backgroundColor: '#0a0a0a' });
                const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
                pdf.save(`Squad_Plan_2026_${select.value}.pdf`);
            });

            render();
        }
        init();
    </script>
</body>
</html>
