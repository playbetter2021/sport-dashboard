<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Squad Planner & Tactical Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; --pitch: #0f1a0f; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F9E272 50%, #B8860B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .pitch-bg { 
            background: radial-gradient(circle at center, #1a331a 0%, #0d1a0d 100%);
            border: 3px solid rgba(255,255,255,0.1);
            position: relative;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .player-node { width: 64px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .player-node:hover { transform: scale(1.15) translateY(-5px); z-index: 50; }
        .rating-badge { position: absolute; top: -5px; right: -5px; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 900; color: black; border: 1px solid black; }
        .glass-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 1.5rem; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1500px] mx-auto">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-10 border-b border-white/5 pb-6 gap-4">
            <div>
                <h1 class="text-3xl font-black italic gold-gradient uppercase tracking-tighter">Elite<span class="text-white not-italic">Planner</span></h1>
                <p id="authMeta" class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.3em]"></p>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <a href="index.html" class="px-5 py-2.5 bg-white/5 border border-white/20 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Player Dossiers</a>
                <a href="overview.html" class="px-5 py-2.5 bg-white/5 border border-white/20 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Team Hub</a>
                <a href="coach.html" class="px-5 py-2.5 bg-white/5 border border-white/20 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Coach Terminal</a>
                <div id="adminLink" class="hidden">
                    <a href="admin_panel.html" class="px-5 py-2.5 border border-purple-500/30 text-purple-400 rounded-full text-[10px] font-bold uppercase hover:bg-purple-500/10 transition">Admin Panel</a>
                </div>
                <button onclick="sessionStorage.clear(); window.location.href='login.html';" class="px-5 py-2.5 bg-red-500/10 border border-red-500/20 rounded-full text-[10px] font-bold uppercase text-red-500 hover:bg-red-500/20 transition">Logout</button>
                <select id="teamSelect" class="bg-black border border-yellow-700/50 text-yellow-500 py-2.5 px-8 rounded-full text-xs font-bold outline-none cursor-pointer shadow-2xl"></select>
            </div>
        </header>

        <div id="captureArea" class="grid grid-cols-1 xl:grid-cols-12 gap-8 bg-[#0a0a0a] p-8 rounded-[3rem] border border-white/10 shadow-2xl">
            <div class="xl:col-span-8">
                <div class="pitch-bg rounded-[2.5rem] aspect-[4/3] relative overflow-hidden shadow-inner p-10">
                    <div class="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
                        <div class="w-40 h-40 border-2 border-white rounded-full"></div>
                        <div class="absolute w-full h-[2px] bg-white top-1/2"></div>
                    </div>

                    <div id="formationGrid" class="relative w-full h-full flex flex-col justify-between py-6">
                        <div class="flex justify-around items-center" id="line-FW"></div>
                        <div class="flex justify-around items-center" id="line-MF"></div>
                        <div class="flex justify-around items-center" id="line-DF"></div>
                        <div class="flex justify-center items-center" id="line-GK"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-center">
                    <button id="exportPdf" class="bg-yellow-600 text-black px-10 py-4 rounded-full text-xs font-black uppercase tracking-widest shadow-xl hover:bg-yellow-400 transition">Download Tactical Report</button>
                </div>
            </div>

            <div class="xl:col-span-4 space-y-6">
                <div class="glass-card p-8">
                    <h3 class="text-xs font-black text-yellow-500 uppercase mb-8 border-l-4 border-yellow-500 pl-4 tracking-widest">Linie Kwaliteit (4-3-3)</h3>
                    <div id="lineAnalysis" class="space-y-6"></div>
                </div>

                <div class="glass-card p-8">
                    <h3 class="text-xs font-black text-gray-500 uppercase mb-6 tracking-widest border-b border-white/5 pb-2">Reserves & Rotatie</h3>
                    <div id="benchList" class="space-y-3 max-h-[350px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        // 1. AUTH GUARD
        const sessionUser = sessionStorage.getItem('elite_user');
        if (!sessionUser) window.location.href = 'login.html';
        const currentUser = JSON.parse(sessionUser);

        if (currentUser.role === 'admin') {
            document.getElementById('adminLink').classList.remove('hidden');
        }
        document.getElementById('authMeta').innerText = `Planner Access: ${currentUser.name}`;

        const calcIndex = (p) => {
            const obj = Math.round((p.obj?.attendance * 0.4) + ((p.obj?.minutes / 1500) * 100 * 0.6));
            const coach = Math.round((Object.values(p.ratings || {}).reduce((a,b)=>parseInt(a)+parseInt(b),0)/(Object.keys(p.ratings || {}).length*5 || 1))*100);
            return Math.round((obj * 0.65) + (p.stats?.Techniek * 0.20 || 10) + (coach * 0.15));
        };

        async function init() {
            const allPlayers = await DataProvider.getAllPlayers();
            
            // 2. FILTER TEAMS VOOR SELECTOR
            const availableTeams = (currentUser.role === 'admin' || currentUser.teams.includes("ALL"))
                ? [...new Set(allPlayers.map(p => p.bio.team))]
                : currentUser.teams;

            const teamSelect = document.getElementById('teamSelect');
            teamSelect.innerHTML = availableTeams.map(t => `<option value="${t}">${t}</option>`).join('');

            const render = () => {
                const team = teamSelect.value;
                const players = allPlayers.filter(p => p.bio.team === team)
                    .map(p => ({...p, finalIndex: calcIndex(p)}))
                    .sort((a,b) => b.finalIndex - a.finalIndex);

                // Reset
                ['FW', 'MF', 'DF', 'GK'].forEach(l => document.getElementById(`line-${l}`).innerHTML = '');
                const bench = [];
                const limits = { Aanvaller: 3, Middenvelder: 3, Verdediger: 4, Keeper: 1 };
                const counts = { Aanvaller: 0, Middenvelder: 0, Verdediger: 0, Keeper: 0 };

                players.forEach(p => {
                    const role = p.bio.role;
                    if (counts[role] < limits[role]) {
                        const line = role === 'Aanvaller' ? 'FW' : (role === 'Middenvelder' ? 'MF' : (role === 'Verdediger' ? 'DF' : 'GK'));
                        document.getElementById(`line-${line}`).innerHTML += createNode(p);
                        counts[role]++;
                    } else {
                        bench.push(p);
                    }
                });

                renderBench(bench);
                renderAnalysis(players, counts, limits);
            };

            const createNode = (p) => {
                const color = p.finalIndex > 75 ? 'bg-green-500' : (p.finalIndex > 60 ? 'bg-yellow-500' : 'bg-red-500');
                return `
                    <div class="player-node text-center relative">
                        <div class="rating-badge ${color}">${p.finalIndex}</div>
                        <img src="${p.bio.photo}" class="w-16 h-16 rounded-full border-2 border-white/20 mx-auto object-cover bg-black shadow-2xl">
                        <p class="text-[9px] font-black uppercase mt-2 truncate w-full tracking-tighter">${p.bio.name.split(' ')[0]}</p>
                    </div>
                `;
            };

            const renderBench = (list) => {
                document.getElementById('benchList').innerHTML = list.map(p => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <img src="${p.bio.photo}" class="w-8 h-8 rounded-full object-cover">
                            <span class="text-[10px] font-bold uppercase">${p.bio.name}</span>
                        </div>
                        <span class="text-[10px] font-black text-yellow-500">${p.finalIndex}%</span>
                    </div>
                `).join('');
            };

            const renderAnalysis = (data, counts, limits) => {
                const lines = [
                    { name: 'Aanval', key: 'Aanvaller' },
                    { name: 'Middenveld', key: 'Middenvelder' },
                    { name: 'Defensie', key: 'Verdediger' }
                ];
                document.getElementById('lineAnalysis').innerHTML = lines.map(line => {
                    const linePlayers = data.filter(p => p.bio.role === line.key);
                    const avg = linePlayers.length ? Math.round(linePlayers.reduce((a,b)=>a+b.finalIndex,0)/linePlayers.length) : 0;
                    return `
                        <div class="space-y-2">
                            <div class="flex justify-between text-[10px] font-black uppercase">
                                <span class="text-gray-400">${line.name}</span>
                                <span class="text-white">${avg}% AVG</span>
                            </div>
                            <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-600" style="width: ${avg}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            teamSelect.addEventListener('change', render);
            document.getElementById('exportPdf').addEventListener('click', async () => {
                const canvas = await html2canvas(document.getElementById('captureArea'), { scale: 2, backgroundColor: '#0a0a0a' });
                const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
                pdf.save(`Tactical_Report_2026_${teamSelect.value}.pdf`);
            });

            render();
        }

        init();
    </script>
</body>
</html>
