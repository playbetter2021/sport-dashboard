<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Admin Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; }
        
        .glass-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 1.5rem; transition: all 0.3s ease; }
        
        .input-luxe { background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); color: white; padding: 10px; border-radius: 8px; width: 100%; font-size: 13px; outline: none; transition: 0.3s; }
        .input-luxe:focus { border-color: var(--gold); background: rgba(255,255,255,0.1); }
        
        /* FIX: Zwarte achtergrond voor dropdown opties */
        .input-luxe option { background-color: #000; color: white; padding: 5px; }

        .team-badge { 
            padding: 6px 10px; font-size: 10px; font-weight: 800; border-radius: 6px; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer; transition: all 0.2s ease; text-align: center;
        }
        .team-badge:hover { background: rgba(212,175,55,0.1); border-color: var(--gold); }
        .team-badge.selected { background: var(--gold); color: black; border-color: var(--gold); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }

        .cat-btn { font-size: 8px; font-weight: 900; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .cat-btn:hover { background: white; color: black; }

        .gen-btn { background: rgba(212,175,55,0.1); color: var(--gold); border: 1px solid var(--gold); padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; transition: 0.2s; }
        .gen-btn:hover { background: var(--gold); color: black; }

        .tab-btn { background: transparent; color: gray; border-bottom: 2px solid transparent; font-weight: 800; text-transform: uppercase; font-size: 11px; padding: 10px 20px; transition: 0.3s; }
        .tab-btn.active { color: var(--gold); border-bottom: 2px solid var(--gold); }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
        
        .nav-item:hover { border-color: rgba(212, 175, 55, 0.5); transform: translateY(-2px); background: rgba(255, 255, 255, 0.05); }
        .coach-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold); background: #222; }
        
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .hidden { display: none; }

        /* --- SPELERSKAART CSS --- */
        .player-card-container {
            position: relative; width: 220px; height: 320px; border-radius: 1.5rem;
            overflow: hidden; border: 2px solid var(--gold); margin: 0 auto;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2), 0 20px 40px rgba(0,0,0,0.8);
            background: #000; transition: transform 0.3s;
        }
        .player-card-photo { width: 100%; height: 100%; object-fit: cover; opacity: 0.85; }
        .player-card-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 15px;
            background: linear-gradient(to top, rgba(0,0,0,1) 15%, transparent 100%);
        }
        .player-card-number {
            position: absolute; top: 15px; right: 20px;
            font-size: 42px; font-weight: 900; color: #fff;
            text-shadow: 0 0 15px var(--gold); z-index: 10; line-height: 1;
        }
        .player-card-name { font-size: 24px; font-weight: 900; font-style: italic; text-transform: uppercase; color: #fff; line-height: 0.85; }
        .player-card-info { font-size: 9px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-top: 5px; }
    </style>
</head>
<body class="p-8 text-left text-xs">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-white/5 pb-6 text-left">
            <div>
                <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter underline decoration-yellow-500">Admin<span class="text-yellow-500">Control</span></h1>
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">User & Team Management System</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-white/5 border border-white/20 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">‚Üê Dashboard</a>
            </div>
        </header>

        <section class="mb-12">
            <h3 class="text-gray-500 font-black uppercase text-[10px] mb-6 tracking-[0.2em] text-left">Systeem Navigatie</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                <a href="index.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>üè†</span><div class="text-[9px] font-black uppercase leading-tight">Dashboard</div></a>
                <a href="overview.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>üìã</span><div class="text-[9px] font-black uppercase leading-tight">Overview</div></a>
                <a href="comparison.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>‚öñÔ∏è</span><div class="text-[9px] font-black uppercase leading-tight">Matrix</div></a>
                <a href="coach.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>üß†</span><div class="text-[9px] font-black uppercase leading-tight">Coach Portal</div></a>
                <a href="planner.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>üìÖ</span><div class="text-[9px] font-black uppercase leading-tight">Planner</div></a>
                <a href="seasonal_analysis.html" class="glass-card p-4 nav-item flex items-center gap-3 group"><span>üìä</span><div class="text-[9px] font-black uppercase leading-tight">Seasonal</div></a>
                <a href="login.html" class="glass-card p-4 nav-item flex items-center gap-3 group border-dashed"><span>üîí</span><div class="text-[9px] font-black uppercase leading-tight">Logout</div></a>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-6"> <div class="glass-card p-8">
                    <div class="flex border-b border-white/10 mb-6">
                        <button onclick="switchTab('coach')" id="tab-coach" class="tab-btn active">Coach Manager</button>
                        <button onclick="switchTab('player')" id="tab-player" class="tab-btn">Speler Manager</button>
                    </div>

                    <div id="coachFormContainer">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-yellow-500 font-black uppercase text-xs italic">Coach Configureren</h3>
                            <button type="button" onclick="resetForm()" class="text-[8px] font-black uppercase text-gray-500 hover:text-white transition">Reset</button>
                        </div>
                        <form id="userForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Volledige Naam</label><input type="text" id="uName" class="input-luxe text-left" required></div>
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Login Naam</label><input type="text" id="uUsername" class="input-luxe text-left" required></div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Profielfoto (Upload of URL)</label>
                                <div class="flex gap-2">
                                    <div class="file-upload-wrapper flex-shrink-0 w-1/3">
                                        <button type="button" class="input-luxe bg-white/10 border-dashed border-white/20 text-[9px] h-full uppercase font-bold">Bestand</button>
                                        <input type="file" id="fileInput" accept="image/*">
                                    </div>
                                    <input type="text" id="uPhoto" class="input-luxe flex-grow text-left" placeholder="Plak URL...">
                                </div>
                                <p id="fileName" class="text-[8px] text-gray-500 mt-1 italic text-left"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-[10px] font-bold text-gray-500 block uppercase">Wachtwoord</label>
                                        <button type="button" class="gen-btn" onclick="generatePass()">Gen</button>
                                    </div>
                                    <input type="text" id="uPassword" class="input-luxe text-left" required>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Rol</label>
                                    <select id="uRole" class="input-luxe text-left">
                                        <option value="coach">Hoofdcoach</option>
                                        <option value="assistant">Assistent</option>
                                        <option value="admin">Admin / TC</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-end mb-3">
                                    <label class="text-[10px] font-bold text-gray-500 block uppercase tracking-widest text-left">Koppel Teams</label>
                                    <div id="categoryGrid" class="flex flex-wrap gap-1"></div>
                                </div>
                                <div id="teamGrid" class="grid grid-cols-4 md:grid-cols-6 gap-2 max-h-[180px] overflow-y-auto pr-2 custom-scroll border border-white/5 p-3 rounded-xl"></div>
                            </div>
                        </form>
                    </div>

                    <div id="playerFormContainer" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-yellow-500 font-black uppercase text-xs italic">Nieuwe Speler Invoeren</h3>
                            <button type="button" onclick="resetPlayerForm()" class="text-[8px] font-black uppercase text-gray-500 hover:text-white transition">Reset</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="flex justify-center md:justify-start">
                                <div class="player-card-container">
                                    <div id="dispNumber" class="player-card-number">--</div>
                                    <img id="pPreviewImg" class="player-card-photo" src="https://via.placeholder.com/400x600/000000/FFFFFF?text=FOTO" alt="Preview">
                                    <div class="player-card-overlay">
                                        <div id="dispName" class="player-card-name">NAAM</div>
                                        <div id="dispTeam" class="player-card-info">TEAM ‚Ä¢ POSITIE</div>
                                    </div>
                                </div>
                            </div>

                            <form id="playerForm" class="space-y-4">
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Naam Speler</label><input type="text" id="pName" class="input-luxe text-left" placeholder="Volledige naam..." required oninput="updateCard()"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Team</label><select id="pTeamSelect" class="input-luxe text-left" onchange="updateCard()"></select></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Rugnummer</label><input type="number" id="pNumber" class="input-luxe text-left" oninput="updateCard()"></div>
                                    <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Positie</label>
                                        <select id="pPos" class="input-luxe text-left" onchange="updateCard()">
                                            <option>Keeper</option><option>Verdediger</option><option>Middenvelder</option><option>Aanvaller</option>
                                        </select>
                                    </div>
                                </div>
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Foto URL</label><input type="text" id="pPhotoUrl" class="input-luxe text-left" placeholder="https://..." oninput="updateCard()"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase text-left">Email Ouder</label><input type="email" id="pEmail" class="input-luxe text-left"></div>
                            </form>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-white/5 space-y-3 mt-4">
                        <input type="password" id="ghToken" placeholder="GitHub Token" class="input-luxe text-center">
                        <button type="button" onclick="handleMainSubmit()" class="w-full bg-yellow-600 text-black font-black py-4 rounded-xl uppercase text-[10px] tracking-[0.2em] hover:bg-yellow-400 transition shadow-lg">Opslaan & Sync</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6">
                <div class="glass-card p-8 h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-yellow-500 font-black uppercase text-xs italic">Staff Bezetting</h3>
                        <button id="exportUsers" class="text-[9px] font-black uppercase text-gray-500 hover:text-white transition">Export CSV</button>
                    </div>
                    <div class="overflow-x-auto custom-scroll max-h-[600px]">
                        <table class="w-full text-left text-[10px]">
                            <thead class="text-gray-500 border-b border-white/5 uppercase font-black text-[9px]">
                                <tr><th class="pb-4">Coach</th><th class="pb-4 text-center">Rol</th><th class="pb-4 text-center">Teams</th><th class="pb-4 text-right">Actie</th></tr>
                            </thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const sessionUser = JSON.parse(sessionStorage.getItem('elite_user'));
        if (!sessionUser || sessionUser.role !== 'admin') window.location.href = 'login.html';

        const levels = ["JO8", "JO9", "JO10", "JO11", "JO12", "JO13", "JO14", "JO15", "JO16", "JO17", "JO19", "Senioren"];
        let selectedTeams = new Set();
        let allUsers = [];
        let allPlayers = [];

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(tab === 'coach') {
                document.getElementById('coachFormContainer').classList.remove('hidden');
                document.getElementById('playerFormContainer').classList.add('hidden');
            } else {
                document.getElementById('coachFormContainer').classList.add('hidden');
                document.getElementById('playerFormContainer').classList.remove('hidden');
            }
        };

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').innerText = `Gekozen: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (event) => { document.getElementById('uPhoto').value = event.target.result; };
                reader.readAsDataURL(file);
            }
        });

        window.generatePass = () => { document.getElementById('uPassword').value = "Elite-" + Math.floor(1000 + Math.random() * 9000); };
        
        window.resetForm = () => {
            document.getElementById('userForm').reset();
            document.getElementById('fileName').innerText = "";
            selectedTeams.clear();
            document.querySelectorAll('.team-badge').forEach(b => b.classList.remove('selected'));
        };

        window.resetPlayerForm = () => {
            document.getElementById('playerForm').reset();
            updateCard();
        };

        // CARD PREVIEW UPDATE FUNCTIE
        window.updateCard = () => {
            const name = document.getElementById('pName').value || "NAAM";
            const number = document.getElementById('pNumber').value || "--";
            const team = document.getElementById('pTeamSelect').value;
            const pos = document.getElementById('pPos').value;
            const photo = document.getElementById('pPhotoUrl').value || "https://via.placeholder.com/400x600/000000/FFFFFF?text=FOTO";

            document.getElementById('dispName').innerText = name;
            document.getElementById('dispNumber').innerText = number;
            document.getElementById('dispTeam').innerText = `${team} ‚Ä¢ ${pos}`;
            document.getElementById('pPreviewImg').src = photo;
        };

        const categoryGrid = document.getElementById('categoryGrid');
        categoryGrid.innerHTML = levels.map(l => `<button type="button" class="cat-btn" onclick="toggleCategory('${l}')">${l}</button>`).join('');

        const teamGrid = document.getElementById('teamGrid');
        let adminTeams = [];
        levels.forEach(l => { for(let i=1; i<=4; i++) adminTeams.push(l === "Senioren" ? `Sen ${i}` : `${l}-${i}`); });
        
        // Vul dropdown voor speler formulier
        const pTeamSelect = document.getElementById('pTeamSelect');
        pTeamSelect.innerHTML = adminTeams.map(t => `<option value="${t}">${t}</option>`).join('');

        adminTeams.push("ALL");
        teamGrid.innerHTML = adminTeams.map(t => `<div class="team-badge" data-team="${t}">${t}</div>`).join('');

        teamGrid.onclick = (e) => {
            if(e.target.classList.contains('team-badge')) {
                const t = e.target.dataset.team;
                selectedTeams.has(t) ? selectedTeams.delete(t) : selectedTeams.add(t);
                e.target.classList.toggle('selected');
            }
        };

        window.toggleCategory = (cat) => {
            const badges = document.querySelectorAll(`.team-badge[data-team^="${cat === 'Senioren' ? 'Sen' : cat}"]`);
            const allSelected = Array.from(badges).every(b => selectedTeams.has(b.dataset.team));
            badges.forEach(b => {
                const t = b.dataset.team;
                allSelected ? selectedTeams.delete(t) : selectedTeams.add(t);
                b.classList.toggle('selected', !allSelected);
            });
        };

        async function loadData() {
            try {
                const resU = await fetch('./data/users.json');
                const dataU = await resU.json();
                allUsers = dataU.users;
                renderTable();
                try {
                    const resP = await fetch('./data/players.json');
                    allPlayers = await resP.json();
                    if(!Array.isArray(allPlayers)) allPlayers = [];
                } catch(e) { allPlayers = []; }
            } catch(e) { console.error("Laden mislukt", e); }
        }

        function renderTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = allUsers.map((u, index) => `
                <tr class="border-b border-white/5 hover:bg-white/5 transition">
                    <td class="py-4 flex items-center gap-3">
                        <img src="${u.photo || 'https://via.placeholder.com/150'}" class="coach-img" onerror="this.src='https://via.placeholder.com/150'">
                        <div><span class="font-bold text-white block uppercase">${u.name}</span><span class="text-[8px] text-gray-500 font-bold tracking-widest italic">${u.username}</span></div>
                    </td>
                    <td class="py-4 text-center"><span class="px-2 py-1 rounded bg-white/10 border border-white/5 text-[8px] uppercase font-black text-gray-300">${u.role}</span></td>
                    <td class="py-4 text-center"><div class="flex flex-wrap justify-center gap-1 max-w-[150px] mx-auto">${u.teams.map(t => `<span class="text-[8px] text-yellow-500 font-black border border-yellow-500/20 bg-yellow-500/5 px-1 rounded">${t}</span>`).join('')}</div></td>
                    <td class="py-4 text-right space-x-2">
                        <button onclick="window.editUser(${index})" class="text-blue-400 font-bold uppercase text-[9px] border border-blue-400/20 px-2 py-1 rounded bg-blue-400/5 hover:bg-blue-400/20 transition">Edit</button>
                        <button onclick="window.deleteUser(${index})" class="text-red-500 font-bold uppercase text-[9px] border border-red-500/20 px-2 py-1 rounded bg-red-500/5 hover:bg-red-500/20 transition">Del</button>
                    </td>
                </tr>`).join('');
        }

        window.handleMainSubmit = async () => {
            const token = document.getElementById('ghToken').value;
            if(!token) return alert("GitHub Token vereist.");

            const isCoachTab = document.getElementById('tab-coach').classList.contains('active');

            if(isCoachTab) {
                const newUser = {
                    username: document.getElementById('uUsername').value,
                    password: document.getElementById('uPassword').value,
                    name: document.getElementById('uName').value,
                    role: document.getElementById('uRole').value,
                    photo: document.getElementById('uPhoto').value,
                    teams: Array.from(selectedTeams)
                };
                if(!newUser.username) return alert("Vul gebruikersnaam in.");
                const idx = allUsers.findIndex(u => u.username === newUser.username);
                idx !== -1 ? allUsers[idx] = newUser : allUsers.push(newUser);
                await syncWithGithub(token, `Update User: ${newUser.name}`, { users: allUsers }, 'data/users.json');
                resetForm();
            } else {
                const pName = document.getElementById('pName').value;
                if(!pName) return alert("Vul naam speler in.");
                const newPlayer = {
                    id: "p_" + Date.now(),
                    bio: {
                        name: pName,
                        team: document.getElementById('pTeamSelect').value,
                        number: document.getElementById('pNumber').value,
                        role: document.getElementById('pPos').value,
                        photo: document.getElementById('pPhotoUrl').value,
                        email: document.getElementById('pEmail').value
                    },
                    ratings: {}, comments: {}, history: {}
                };
                allPlayers.push(newPlayer);
                await syncWithGithub(token, `New Player: ${newPlayer.bio.name}`, allPlayers, 'data/players.json');
                resetPlayerForm();
            }
        };

        async function syncWithGithub(token, msg, contentObj, path) {
            try {
                const url = `https://api.github.com/repos/playbetter2021/sport-dashboard/contents/${path}`;
                const getRes = await fetch(url, { headers: { "Authorization": `token ${token}` } });
                let sha = null;
                if(getRes.ok) {
                    const file = await getRes.json();
                    sha = file.sha;
                }
                const putRes = await fetch(url, { 
                    method: "PUT", 
                    headers: { "Authorization": `token ${token}` }, 
                    body: JSON.stringify({ message: msg, content: btoa(JSON.stringify(contentObj, null, 2)), sha: sha }) 
                });
                if(putRes.ok) {
                    alert(`${path} succesvol bijgewerkt!`);
                    if(path === 'data/users.json') loadData();
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }
            } catch (err) { alert("Fout bij synchronisatie: " + err.message); }
        }

        window.deleteUser = async (idx) => {
            const token = document.getElementById('ghToken').value;
            if(!token) return alert("GitHub Token vereist.");
            if(!confirm(`Trainer ${allUsers[idx].name} verwijderen?`)) return;
            const name = allUsers[idx].name;
            allUsers.splice(idx, 1);
            await syncWithGithub(token, `Delete User: ${name}`, { users: allUsers }, 'data/users.json');
        };

        window.editUser = (idx) => {
            switchTab('coach');
            const u = allUsers[idx];
            document.getElementById('uName').value = u.name;
            document.getElementById('uUsername').value = u.username;
            document.getElementById('uPassword').value = u.password;
            document.getElementById('uRole').value = u.role;
            document.getElementById('uPhoto').value = u.photo || '';
            selectedTeams = new Set(u.teams);
            document.querySelectorAll('.team-badge').forEach(b => b.classList.toggle('selected', selectedTeams.has(b.dataset.team)));
        };

        loadData();
    </script>
</body>
</html>
