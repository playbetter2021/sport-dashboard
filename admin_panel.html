<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Admin Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ELITE ENTERPRISE DESIGN SYSTEM --- */
        :root {
            --bg-body: #09090b; --bg-surface: #121215; --bg-panel: #18181b; --bg-element: #27272a;
            --border-subtle: #27272a; --border-strong: #3f3f46;
            --text-primary: #f4f4f5; --text-secondary: #a1a1aa; --text-tertiary: #52525b;
            --accent: #D4AF37; --danger: #ef4444; --success: #10b981;
            --font-main: 'Inter', sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }

        body { background: var(--bg-body); color: var(--text-primary); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; margin: 0; }

        /* SIDEBAR */
        aside { width: 280px; background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; z-index: 20; }
        .brand-area { padding: 24px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 12px; }
        .logo-mark { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; }
        .nav-item { padding: 12px 24px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--bg-element); color: white; border-left: 2px solid var(--accent); }

        /* MAIN */
        main { flex: 1; position: relative; overflow-y: auto; background: var(--bg-body); }
        .glass-header { position: sticky; top: 0; z-index: 50; background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-subtle); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
        .content-wrapper { padding: 32px; max-width: 1600px; margin: 0 auto; }

        /* PANELS & INPUTS */
        .panel { background: var(--bg-panel); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
        .panel-header { padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 13px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; }

        .input-dark { background: var(--bg-element); border: 1px solid var(--border-subtle); color: white; padding: 10px 12px; border-radius: 6px; font-size: 13px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: var(--accent); background: #000; }
        
        /* TABS & FILTERS */
        .tab-btn { padding: 10px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .filter-chip { font-size: 9px; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border-subtle); color: var(--text-secondary); cursor: pointer; text-transform: uppercase; font-weight: 700; }
        .filter-chip.active { background: var(--accent); color: black; border-color: var(--accent); }

        /* TEAM BADGES */
        .team-badge { 
            font-size: 9px; padding: 6px 4px; border-radius: 4px; background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border-subtle); cursor: pointer; transition: 0.2s; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .team-badge:hover { border-color: var(--accent); background: rgba(255,255,255,0.05); }
        .team-badge.selected { background: rgba(212, 175, 55, 0.2); color: var(--accent); border-color: var(--accent); font-weight: 800; }

        /* PREVIEW & LOGS */
        .card-preview { width: 140px; height: 200px; border-radius: 12px; background: #000; border: 1px solid var(--accent); position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 0 auto; }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: linear-gradient(to top, black, transparent); }
        .log-console { font-family: var(--font-mono); font-size: 10px; color: var(--success); height: 150px; overflow-y: auto; background: #050505; padding: 12px; border-radius: 8px; border: 1px solid var(--border-subtle); }
        .log-entry { margin-bottom: 4px; display: flex; gap: 8px; }
        .log-time { color: var(--text-tertiary); }

        /* BUTTONS */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }
    </style>
</head>
<body>

    <aside>
        <div class="brand-area">
            <div class="logo-mark">EP</div>
            <div class="font-bold text-base tracking-tight">ELITE<span>PRO</span></div>
        </div>
        <div class="py-6 flex flex-col gap-1">
            <div class="nav-item" onclick="window.location.href='index.html'">üè† Dashboard</div>
            <div class="nav-item active">‚öôÔ∏è Admin Console</div>
            <div class="mt-8 text-[10px] uppercase font-bold text-gray-600 px-6 mb-2 tracking-widest">Modules</div>
            <div class="nav-item" onclick="window.location.href='overview.html'">üìä Team Hub</div>
            <div class="nav-item" onclick="window.location.href='planner.html'">‚ôüÔ∏è Planner</div>
        </div>
        <div class="mt-auto p-6 border-t border-[#27272a]">
             <div class="flex items-center gap-2 mb-2">
                 <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                 <span class="text-xs text-white font-bold">Admin Mode</span>
             </div>
             <div class="text-[10px] text-gray-500">Root Access Granted</div>
        </div>
    </aside>

    <main>
        <header class="glass-header">
            <div class="flex flex-col">
                <h1 class="text-sm font-bold text-white uppercase tracking-wider">System Administration</h1>
                <span class="text-xs text-gray-500">User Management & Data Integrity</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="px-3 py-1 rounded bg-white/5 border border-white/10 text-[10px] font-mono">
                    <span class="text-gray-400">DB Status:</span> <span class="text-green-500 font-bold">CONNECTED</span>
                </div>
                <button onclick="sessionStorage.clear(); window.location.href='login.html';" class="btn btn-ghost text-[10px]">Logout</button>
            </div>
        </header>

        <div class="content-wrapper">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-7 space-y-6">
                    <div class="flex border-b border-white/10 mb-2">
                        <button onclick="switchTab('coach')" id="tab-coach" class="tab-btn active">Coach Manager</button>
                        <button onclick="switchTab('player')" id="tab-player" class="tab-btn">Speler Database</button>
                    </div>

                    <div id="coachFormContainer" class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Gebruiker Beheren</div>
                            <button onclick="resetForm()" class="text-[10px] text-gray-500 hover:text-white uppercase font-bold">Nieuw / Reset</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Naam</label>
                                    <input type="text" id="uName" class="input-dark" placeholder="Bijv. Mark van Bommel" oninput="autoGenerateCreds()">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Username (Uniek)</label>
                                    <input type="text" id="uUsername" class="input-dark font-mono text-yellow-500" readonly>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Wachtwoord</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="uPassword" class="input-dark font-mono">
                                        <button onclick="generatePass()" class="btn btn-ghost px-2">üé≤</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Systeem Rol</label>
                                    <select id="uRole" class="input-dark">
                                        <option value="coach">Hoofdcoach</option>
                                        <option value="assistant">Assistent</option>
                                        <option value="admin">Admin / TC</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Foto URL</label>
                                <input type="text" id="uPhoto" class="input-dark" placeholder="https://...">
                            </div>

                            <div>
                                <div class="flex justify-between items-end mb-2">
                                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Team Toegang</label>
                                    <div class="flex gap-1" id="teamFilters"></div>
                                </div>
                                <div id="teamGrid" class="grid grid-cols-5 gap-2 h-[140px] overflow-y-auto custom-scroll border border-white/10 p-2 rounded bg-black/20">
                                    </div>
                            </div>
                            
                            <div class="pt-4 border-t border-white/5">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">GitHub API Token (Vereist)</label>
                                <input type="password" id="ghToken" class="input-dark text-center tracking-widest" placeholder="ghp_...">
                            </div>

                            <button onclick="handleMainSubmit()" class="w-full btn btn-primary justify-center py-3 mt-2">
                                Opslaan & Synchroniseren
                            </button>
                        </div>
                    </div>

                    <div id="playerFormContainer" class="panel hidden">
                        <div class="panel-header">
                            <div class="panel-title">Nieuwe Speler</div>
                            <div class="text-[10px] text-yellow-500 font-bold uppercase">Live Preview</div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-12 gap-6">
                                <div class="col-span-4">
                                    <div class="card-preview">
                                        <div id="dispNumber" class="absolute top-2 right-2 text-2xl font-black text-white drop-shadow-md z-10">14</div>
                                        <img id="pPreviewImg" class="card-img" src="https://via.placeholder.com/400x600/000000/FFFFFF?text=PRO">
                                        <div class="card-overlay">
                                            <div id="dispName" class="text-white font-black uppercase text-sm leading-none italic">NAAM</div>
                                            <div id="dispTeam" class="text-[8px] text-yellow-500 font-bold uppercase mt-1">TEAM ‚Ä¢ POS</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-8 space-y-3">
                                    <input type="text" id="pName" class="input-dark" placeholder="Volledige Naam" oninput="updateCard()">
                                    <div class="grid grid-cols-2 gap-3">
                                        <select id="pTeamSelect" class="input-dark" onchange="updateCard()"></select>
                                        <input type="number" id="pNumber" class="input-dark" placeholder="Nr" oninput="updateCard()">
                                    </div>
                                    <select id="pPos" class="input-dark" onchange="updateCard()">
                                        <option>Middenvelder</option>
                                        <option>Aanvaller</option>
                                        <option>Verdediger</option>
                                        <option>Keeper</option>
                                    </select>
                                    <input type="text" id="pPhotoUrl" class="input-dark" placeholder="Foto URL" oninput="updateCard()">
                                    <button onclick="handleMainSubmit()" class="w-full btn btn-primary justify-center py-3 mt-4">Speler Toevoegen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-5 space-y-6">
                    <div class="panel h-[400px] flex flex-col">
                        <div class="panel-header">
                            <div class="panel-title">Gebruikers</div>
                            <span id="userCount" class="text-xs text-gray-500 font-mono">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scroll">
                            <table class="w-full text-left text-[10px]">
                                <thead class="text-gray-500 border-b border-white/5 bg-black/20">
                                    <tr><th class="p-3">User</th><th class="p-3">Rol</th><th class="p-3 text-right">Actie</th></tr>
                                </thead>
                                <tbody id="userTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Audit Log</div>
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        </div>
                        <div class="log-console" id="auditLog"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        const loadJSON = async (file) => {
            try { const r = await fetch(`./data/${file}`); return await r.json(); } 
            catch(e) { console.error(e); return []; }
        };

        let allUsers = [];
        let allPlayers = [];
        let selectedTeams = new Set();
        let currentFilter = 'ALL';

        // 1. Genereer Teams (Veel meer teams nu)
        const generateTeamList = () => {
            const list = [];
            const add = (prefix, start, end, amount) => {
                for(let i=start; i<=end; i++) {
                    for(let t=1; t<=amount; t++) list.push(`${prefix}${i}-${t}`);
                }
            };
            add("JO", 7, 12, 4); 
            add("JO", 13, 19, 3);
            add("MO", 13, 20, 2);
            for(let i=1; i<=8; i++) list.push(`Sen ${i}`);
            return list;
        };
        const allTeams = generateTeamList();

        // 2. Init
        const sessionUser = JSON.parse(sessionStorage.getItem('elite_user'));
        if (!sessionUser || sessionUser.role !== 'admin') window.location.href = 'login.html';
        
        const log = (msg) => {
            const box = document.getElementById('auditLog');
            const time = new Date().toLocaleTimeString('nl-NL');
            box.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> <span>${msg}</span></div>`;
            box.scrollTop = box.scrollHeight;
        };

        async function init() {
            log("Admin Console Initialized...");
            const uData = await loadJSON('users.json');
            allUsers = uData.users || [];
            allPlayers = await loadJSON('players.json');
            if(!Array.isArray(allPlayers)) allPlayers = [];

            log(`Data: ${allUsers.length} users, ${allPlayers.length} players.`);
            renderUserTable();
            renderTeamFilters();
            renderTeamGrid();
            populateDropdowns();
            updateCard();
        }

        // 3. UI Renders
        function renderTeamFilters() {
            const filters = [
                { id: 'ALL', label: 'Alles' },
                { id: 'JO7-JO12', label: 'Onderbouw' },
                { id: 'JO13-JO19', label: 'Bovenbouw' },
                { id: 'MO', label: 'Meiden' },
                { id: 'Sen', label: 'Senioren' }
            ];
            document.getElementById('teamFilters').innerHTML = filters.map(f => `
                <div class="filter-chip ${f.id === 'ALL' ? 'active' : ''}" onclick="applyTeamFilter('${f.id}', this)">${f.label}</div>
            `).join('');
        }

        window.applyTeamFilter = (filter, el) => {
            currentFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderTeamGrid();
        };

        function renderTeamGrid() {
            const grid = document.getElementById('teamGrid');
            const visibleTeams = allTeams.filter(t => {
                if(currentFilter === 'ALL') return true;
                if(currentFilter === 'Sen') return t.startsWith('Sen');
                if(currentFilter === 'MO') return t.startsWith('MO');
                if(t.startsWith('JO')) {
                    const age = parseInt(t.split('-')[0].replace('JO', ''));
                    if(currentFilter === 'JO7-JO12') return age <= 12;
                    if(currentFilter === 'JO13-JO19') return age >= 13;
                }
                return false;
            });
            grid.innerHTML = visibleTeams.map(t => {
                const isSelected = selectedTeams.has(t) ? 'selected' : '';
                return `<div class="team-badge ${isSelected}" data-team="${t}" onclick="toggleTeam('${t}', this)">${t}</div>`;
            }).join('');
        }

        window.toggleTeam = (t, el) => {
            selectedTeams.has(t) ? selectedTeams.delete(t) : selectedTeams.add(t);
            el.classList.toggle('selected');
        };

        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            document.getElementById('userCount').innerText = allUsers.length;
            tbody.innerHTML = allUsers.map((u, i) => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gray-700 border border-gray-600 overflow-hidden">
                                <img src="${u.photo || ''}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                            </div>
                            <div>
                                <div class="font-bold text-white">${u.name}</div>
                                <div class="text-[9px] text-gray-500">${u.username}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${u.role==='admin'?'bg-red-500/20 text-red-400':'bg-blue-500/20 text-blue-400'}">${u.role}</span></td>
                    <td class="p-3 text-right space-x-2">
                         <button onclick="editUser(${i})" class="text-yellow-500 hover:text-white font-bold" title="Edit">‚úé</button>
                        <button onclick="deleteUser(${i})" class="text-red-500 hover:text-white font-bold" title="Delete">√ó</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- 4. EDIT FUNCTIONALITEIT ---
        window.editUser = (i) => {
            const u = allUsers[i];
            
            // Switch tab to form
            switchTab('coach');
            
            // Fill Form
            document.getElementById('uName').value = u.name;
            document.getElementById('uUsername').value = u.username;
            document.getElementById('uPassword').value = u.password;
            document.getElementById('uRole').value = u.role;
            document.getElementById('uPhoto').value = u.photo || '';
            
            // Set Selected Teams
            selectedTeams = new Set(u.teams || []);
            
            // Refresh Grid Visuals
            renderTeamGrid();
            
            log(`Editing user: ${u.name}`);
        };

        // 5. Standard Helpers
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(tab === 'coach') {
                document.getElementById('coachFormContainer').classList.remove('hidden');
                document.getElementById('playerFormContainer').classList.add('hidden');
            } else {
                document.getElementById('coachFormContainer').classList.add('hidden');
                document.getElementById('playerFormContainer').classList.remove('hidden');
            }
        };

        window.autoGenerateCreds = () => {
            const name = document.getElementById('uName').value;
            if(name.length > 3 && !document.getElementById('uUsername').value) { // Only if empty
                const parts = name.toLowerCase().split(' ');
                const user = parts.length > 1 ? `${parts[0][0]}.${parts[parts.length-1]}` : parts[0];
                document.getElementById('uUsername').value = user;
            }
        };

        window.generatePass = () => {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let pass = "EP-";
            for(let i=0; i<6; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('uPassword').value = pass;
        };

        window.updateCard = () => {
            const name = document.getElementById('pName').value || "NAAM SPELER";
            const team = document.getElementById('pTeamSelect').value || "TEAM";
            const num = document.getElementById('pNumber').value || "99";
            const img = document.getElementById('pPhotoUrl').value;
            const pos = document.getElementById('pPos').value;
            document.getElementById('dispName').innerText = name;
            document.getElementById('dispTeam').innerText = `${team} ‚Ä¢ ${pos.substring(0,3).toUpperCase()}`;
            document.getElementById('dispNumber').innerText = num;
            if(img) document.getElementById('pPreviewImg').src = img;
        };
        
        function populateDropdowns() {
            document.getElementById('pTeamSelect').innerHTML = allTeams.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        window.resetForm = () => {
            document.getElementById('uName').value = '';
            document.getElementById('uUsername').value = '';
            document.getElementById('uPassword').value = '';
            document.getElementById('uPhoto').value = '';
            selectedTeams.clear();
            renderTeamGrid();
        };

        window.handleMainSubmit = async () => {
            const token = document.getElementById('ghToken').value;
            if(!token) { log("ERROR: Token vereist."); return alert("GitHub Token vereist"); }

            if(document.getElementById('tab-coach').classList.contains('active')) {
                const newUser = {
                    name: document.getElementById('uName').value,
                    username: document.getElementById('uUsername').value,
                    password: document.getElementById('uPassword').value,
                    role: document.getElementById('uRole').value,
                    photo: document.getElementById('uPhoto').value,
                    teams: Array.from(selectedTeams)
                };
                
                if(!newUser.username) return;
                const idx = allUsers.findIndex(u => u.username === newUser.username);
                if(idx !== -1) allUsers[idx] = newUser; 
                else allUsers.push(newUser);

                log(`Syncing Users DB...`);
                await syncGithub(token, 'users.json', { users: allUsers }, `Update User: ${newUser.name}`);
                renderUserTable();
                resetForm();
            } else {
                const newPlayer = {
                    id: "p_" + Date.now(),
                    bio: {
                        name: document.getElementById('pName').value,
                        team: document.getElementById('pTeamSelect').value,
                        number: document.getElementById('pNumber').value,
                        role: document.getElementById('pPos').value,
                        photo: document.getElementById('pPhotoUrl').value
                    },
                    ratings: {}, history: {}
                };
                allPlayers.push(newPlayer);
                await syncGithub(token, 'players.json', allPlayers, `New Player: ${newPlayer.bio.name}`);
                document.getElementById('pName').value = '';
                updateCard();
            }
        };

        async function syncGithub(token, file, content, msg) {
            const url = `https://api.github.com/repos/playbetter2021/sport-dashboard/contents/data/${file}`;
            try {
                const get = await fetch(url, { headers: { "Authorization": `token ${token}` } });
                const json = await get.json();
                const sha = json.sha;
                const put = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}` },
                    body: JSON.stringify({ message: msg, content: btoa(JSON.stringify(content, null, 2)), sha: sha })
                });
                if(put.ok) { log("SUCCESS: Opgeslagen."); alert("Opgeslagen!"); }
                else throw new Error("GitHub Error");
            } catch(e) { log("ERROR: Sync failed."); console.error(e); alert("Fout bij opslaan."); }
        }

        window.deleteUser = async (i) => {
            if(confirm("Gebruiker verwijderen?")) {
                allUsers.splice(i, 1);
                renderUserTable();
                log("User deleted locally. Save to sync.");
            }
        };

        init();
    </script>
</body>
</html>
