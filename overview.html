<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Team Intelligence Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM (Consistent met Coach/Mission Control) --- */
        :root {
            --bg-body: #09090b; --bg-surface: #121215; --bg-panel: #18181b; --bg-element: #27272a;
            --border-subtle: #27272a; --border-strong: #3f3f46;
            --text-primary: #f4f4f5; --text-secondary: #a1a1aa; --text-tertiary: #52525b;
            --accent: #D4AF37; --danger: #ef4444; --success: #10b981;
            --font-main: 'Inter', sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }

        body { background: var(--bg-body); color: var(--text-primary); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; margin: 0; }

        /* SIDEBAR */
        aside { width: 280px; background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; z-index: 20; }
        .brand-area { padding: 24px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 12px; }
        .logo-mark { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; }
        .nav-item { padding: 12px 24px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--bg-element); color: white; border-left: 2px solid var(--accent); }

        /* MAIN */
        main { flex: 1; position: relative; overflow-y: auto; background: var(--bg-body); }
        .glass-header { position: sticky; top: 0; z-index: 50; background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-subtle); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
        .content-wrapper { padding: 32px; max-width: 1600px; margin: 0 auto; }

        /* PANELS */
        .panel { background: var(--bg-panel); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
        .panel-header { padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 13px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; position: relative; }
        .kpi-label { font-size: 10px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: 800; color: white; font-family: var(--font-mono); }
        .kpi-sub { font-size: 11px; margin-top: 4px; color: var(--text-secondary); }

        /* DATA TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 20px; color: var(--text-tertiary); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-subtle); background: rgba(255,255,255,0.01); }
        td { padding: 12px 20px; color: var(--text-primary); border-bottom: 1px solid var(--border-subtle); vertical-align: middle; }
        tr:hover td { background: var(--bg-element); cursor: pointer; }
        
        .avatar-cell { display: flex; items-center; gap: 12px; }
        .avatar-small { width: 32px; height: 32px; border-radius: 8px; background: #000; object-fit: cover; border: 1px solid var(--border-subtle); }
        .role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: var(--text-secondary); text-transform: uppercase; }
        
        /* SPARKLINE CANVAS */
        .sparkline { width: 100px; height: 30px; display: block; }

        /* BUTTONS & INPUTS */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: #eac545; }
        .btn-ghost { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .btn-ghost:hover { border-color: var(--text-primary); color: white; }
        
        select.input-dark { background: var(--bg-element); border: 1px solid var(--border-subtle); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; outline: none; }
    </style>
</head>
<body>

    <aside>
        <div class="brand-area">
            <div class="logo-mark">EP</div>
            <div class="font-bold text-base tracking-tight">ELITE<span>PRO</span></div>
        </div>
        <div class="py-6 flex flex-col gap-1">
            <div class="nav-item" onclick="window.location.href='index.html'">üè† Mission Control</div>
            <div class="nav-item active">üìä Team Intelligence</div>
            <div class="nav-item" onclick="window.location.href='comparison.html'">‚öñÔ∏è Comparison</div>
            <div class="nav-item" onclick="window.location.href='coach.html'">üìù Dossier Manager</div>
        </div>
        <div class="mt-auto p-6 border-t border-[#27272a]">
             <div class="text-xs text-gray-500">v2.5.0 Analysis Module</div>
        </div>
    </aside>

    <main>
        <header class="glass-header">
            <div class="flex flex-col">
                <h1 class="text-sm font-bold text-white uppercase tracking-wider">Team Intelligence Hub</h1>
                <span id="adminStatus" class="text-xs text-gray-500">Global Overview</span>
            </div>
            <div class="flex items-center gap-3">
                <label class="text-[10px] font-bold text-gray-500 uppercase">Filter:</label>
                <select id="teamFilter" class="input-dark w-40">
                    <option value="ALL">Alle Teams</option>
                </select>
                <div class="h-6 w-px bg-gray-700 mx-2"></div>
                <button id="exportTeamReport" class="btn btn-primary">Export PDF</button>
            </div>
        </header>

        <div class="content-wrapper">
            
            <div id="kpiGrid" class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Selectie Index</div>
                    <div id="avgScore" class="kpi-value">0%</div>
                    <div class="kpi-sub">Gemiddelde performance</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Elite Potentials</div>
                    <div id="selectionCap" class="kpi-value text-green-500">0</div>
                    <div class="kpi-sub">Spelers > 75 index</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Stagnatie Risico</div>
                    <div id="stagnationCount" class="kpi-value text-red-500">0</div>
                    <div class="kpi-sub">Negatieve groei curve</div>
                </div>
                <div class="kpi-card" style="border-left: 2px solid var(--accent);">
                    <div class="kpi-label">Top Groeier</div>
                    <div id="topGrower" class="kpi-value text-lg truncate">--</div>
                    <div class="kpi-sub text-yellow-500">Hoogste progressie</div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                
                <div class="xl:col-span-9">
                    <div class="panel" id="captureArea">
                        <div class="panel-header">
                            <div class="panel-title">Speler Performance Matrix</div>
                            <div class="text-[10px] text-gray-500">Sorteer op: Index (High-Low)</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th>Speler / Team</th>
                                        <th>Huidige Index</th>
                                        <th>Groei</th>
                                        <th>Trend Curve (Seizoen)</th>
                                        <th class="text-right">Rol</th>
                                    </tr>
                                </thead>
                                <tbody id="hubBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="xl:col-span-3 space-y-6">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">Staff Compliance</div>
                        </div>
                        <div class="p-6">
                            <div class="text-xs text-gray-500 mb-4">Percentage dossiers compleet per team.</div>
                            <div id="staffTracker" class="space-y-5">
                                </div>
                        </div>
                    </div>

                    <div class="panel p-6 bg-gradient-to-br from-yellow-900/10 to-transparent border-yellow-900/20">
                        <h4 class="text-xs font-bold text-yellow-500 uppercase mb-2">üí° Quick Insight</h4>
                        <p id="quickInsight" class="text-xs text-gray-400 leading-relaxed italic">
                            Data analyseert...
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        let allPlayers = [], filteredPlayers = [];

        // Simple calc logic (consistent with other pages)
        const calcIndex = (p) => {
            if(!p.obj && !p.ratings) return 0;
            const obj = Math.round(((p.obj?.attendance || 80) * 0.4) + 50);
            
            // Safe reduce for ratings
            let coach = 70;
            if(p.ratings) {
                const values = Object.values(p.ratings);
                if(values.length > 0) coach = Math.round((values.reduce((a,b)=>a+b,0) / values.length) * 10);
            }
            
            // Weighting
            return Math.round((obj * 0.65) + (coach * 0.35));
        };

        async function init() {
            allPlayers = await DataProvider.getAllPlayers();
            
            // Populate Dropdown
            const teams = [...new Set(allPlayers.map(p => p.bio.team))].sort();
            const filterSelect = document.getElementById('teamFilter');
            teams.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.innerText = t;
                filterSelect.appendChild(opt);
            });

            filterSelect.addEventListener('change', render);
            render();
        }

        function render() {
            const selectedTeam = document.getElementById('teamFilter').value;
            filteredPlayers = (selectedTeam === "ALL") ? allPlayers : allPlayers.filter(p => p.bio.team === selectedTeam);

            // Sort by Index High -> Low
            filteredPlayers.sort((a,b) => calcIndex(b) - calcIndex(a));

            const hubBody = document.getElementById('hubBody');
            hubBody.innerHTML = "";

            // KPI Trackers
            let totalIndex = 0, eliteCount = 0, stagnations = 0;
            let grower = { name: '-', val: -999 };
            const teamStats = {};

            filteredPlayers.forEach(p => {
                // Determine Historical Data for Sparkline & Growth
                const s1 = p.history?.["1e seizoenshelft"] ? calcIndex({...p, ...p.history["1e seizoenshelft"]}) : 65; // Mock start
                const s2 = p.history?.["2e seizoenshelft"] ? calcIndex({...p, ...p.history["2e seizoenshelft"]}) : null;
                const sCurrent = calcIndex(p);
                
                // Growth calc (Current vs Start)
                const growth = sCurrent - s1;
                
                // KPI Updates
                totalIndex += sCurrent;
                if(sCurrent > 75) eliteCount++;
                if(growth < 0) stagnations++;
                if(growth > grower.val) grower = { name: p.bio.name, val: growth };

                // Team Compliance Stats
                if(!teamStats[p.bio.team]) teamStats[p.bio.team] = { count: 0, locked: 0 };
                teamStats[p.bio.team].count++;
                // Check if current period is locked (mock 'Eindbeoordeling')
                if(p.history?.['Eindbeoordeling']?.status === 'locked') teamStats[p.bio.team].locked++;

                // Render Row
                const row = document.createElement('tr');
                row.className = "group border-b border-[#27272a]";
                row.innerHTML = `
                    <td>
                        <div class="avatar-cell">
                            <img src="${p.bio.photo || 'https://via.placeholder.com/32'}" class="avatar-small">
                            <div>
                                <div class="text-xs font-bold text-white group-hover:text-yellow-500 transition">${p.bio.name}</div>
                                <div class="text-[10px] text-gray-500">${p.bio.team}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="text-sm font-bold text-white font-mono">${sCurrent}</span>
                    </td>
                    <td>
                        <span class="text-xs font-bold ${growth >= 0 ? 'text-green-500' : 'text-red-500'}">
                            ${growth > 0 ? '+' : ''}${growth}
                        </span>
                    </td>
                    <td class="py-2">
                        <canvas id="c-${p.id}" class="sparkline"></canvas>
                    </td>
                    <td class="text-right">
                        <span class="role-badge">${p.bio.role}</span>
                    </td>
                `;
                
                // Click to go to dossier (Using localStorage method we built)
                row.onclick = () => {
                    localStorage.setItem('selected_player_id', p.id);
                    window.location.href = 'coach.html';
                };

                hubBody.appendChild(row);

                // Render Sparkline (Async to let DOM paint)
                setTimeout(() => {
                    const ctx = document.getElementById(`c-${p.id}`);
                    if(ctx) {
                        const dataPoints = [s1, s2 || (s1+sCurrent)/2, sCurrent]; // Interpolate if missing middle
                        new Chart(ctx, {
                            type: 'line',
                            data: { 
                                labels: [1,2,3], 
                                datasets: [{ 
                                    data: dataPoints, 
                                    borderColor: growth >= 0 ? '#10b981' : '#ef4444', 
                                    borderWidth: 2, 
                                    pointRadius: 0, 
                                    tension: 0.4 
                                }] 
                            },
                            options: { 
                                responsive: false, 
                                maintainAspectRatio: false, 
                                scales: { x: { display: false }, y: { display: false, min: 40, max: 100 } }, 
                                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                                animation: false
                            }
                        });
                    }
                }, 0);
            });

            // Update Header KPIs
            const avg = filteredPlayers.length ? Math.round(totalIndex / filteredPlayers.length) : 0;
            document.getElementById('avgScore').innerText = avg + "%";
            document.getElementById('selectionCap').innerText = eliteCount;
            document.getElementById('stagnationCount').innerText = stagnations;
            document.getElementById('topGrower').innerText = grower.name;

            // Render Staff Compliance
            const staffContainer = document.getElementById('staffTracker');
            staffContainer.innerHTML = Object.entries(teamStats).map(([team, s]) => {
                const pct = Math.round((s.locked / s.count) * 100) || 0;
                let barColor = 'bg-yellow-600';
                if(pct > 80) barColor = 'bg-green-500';
                else if(pct < 30) barColor = 'bg-red-500';

                return `
                <div>
                    <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                        <span class="text-gray-400">${team}</span>
                        <span class="text-white">${pct}%</span>
                    </div>
                    <div class="w-full bg-[#27272a] h-1.5 rounded-full overflow-hidden">
                        <div class="h-full ${barColor}" style="width: ${pct}%"></div>
                    </div>
                </div>`;
            }).join('');

            // AI Insight
            document.getElementById('quickInsight').innerText = 
                `De selectie scoort gemiddeld ${avg}%. ${eliteCount} spelers presteren op Elite niveau. ` +
                `Focus nodig op de ${stagnations} spelers die stagneren ten opzichte van de seizoensstart.`;
        }

        // Export PDF
        document.getElementById('exportTeamReport').addEventListener('click', async () => {
            const btn = document.getElementById('exportTeamReport');
            btn.innerText = "Generating...";
            
            const element = document.getElementById('captureArea');
            const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#18181b' });
            
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            
            // Header in PDF
            pdf.setFillColor(24, 24, 27); // Zinc 900
            pdf.rect(0, 0, 297, 20, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(12);
            pdf.text("ELITE PRO | TEAM INTELLIGENCE REPORT", 10, 13);
            
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = 280;
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 10, 25, pdfWidth, pdfHeight);
            pdf.save(`Elite_Team_Report.pdf`);
            
            btn.innerText = "Export PDF";
        });

        init();
    </script>
</body>
</html>
