<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Coach Terminal & Planning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; --red: #ef4444; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; padding-bottom: 180px; }
        .input-luxe { background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); padding: 10px; border-radius: 8px; width: 100%; font-size: 13px; outline: none; transition: 0.2s; }
        .input-luxe:focus { border-color: var(--gold); background: rgba(212,175,55,0.1); }
        .section-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 25px; border-radius: 1.5rem; margin-bottom: 2rem; }
        label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px; display: block; }
        h3 { font-size: 11px; color: var(--gold); text-transform: uppercase; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 10px; margin-bottom: 20px; font-weight: 900; }
        .slider-gold { accent-color: var(--gold); cursor: pointer; width: 100%; }
        .preview-photo { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; background: #111; box-shadow: 0 0 20px rgba(212,175,55,0.2); }
        .save-bar { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(212, 175, 55, 0.3); padding: 1.5rem; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; }
        .status-missing { color: var(--red); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-6 md:p-10">
    <div id="capture-area" class="max-w-7xl mx-auto">
        
        <header class="flex flex-col xl:flex-row justify-between items-start mb-10 border-b border-white/5 pb-8 gap-6 no-print">
            <div class="space-y-4">
                <h1 class="text-3xl font-black italic text-white uppercase tracking-tighter">COACH<span class="text-yellow-500">TERMINAL</span></h1>
                <div class="flex gap-4">
                    <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                        <label>Deadline 1e Helft</label>
                        <span class="text-white text-xs font-bold">15 Dec 2025</span>
                    </div>
                    <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                        <label>Deadline Eindgesprek</label>
                        <span class="text-yellow-500 text-xs font-bold">01 Juni 2026</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3 w-full xl:w-auto">
                <div class="flex gap-2 bg-white/5 p-2 rounded-xl border border-white/10 w-full">
                    <select id="assetSearch" class="bg-transparent text-yellow-500 font-bold outline-none cursor-pointer min-w-[200px] p-2 text-xs uppercase"></select>
                    <button id="loadBtn" class="bg-yellow-600 text-black px-6 py-2 rounded-lg text-[10px] font-black uppercase hover:bg-yellow-400 transition">Laden</button>
                </div>
                <div id="missingEvalBox" class="text-[10px] text-right">
                    <span class="text-gray-500 font-bold uppercase">Nog te beoordelen:</span>
                    <div id="missingList" class="status-missing font-black">Laden...</div>
                </div>
            </div>
        </header>

        <form id="proForm" class="space-y-6">
            <div class="section-card">
                <div class="flex flex-col md:flex-row gap-8 items-center">
                    <div class="relative">
                        <img id="pPreviewImg" class="preview-photo" src="https://via.placeholder.com/150/0a0a0a/D4AF37?text=ELITE" alt="Preview">
                    </div>
                    
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                        <div class="md:col-span-2"><label>Naam Speler</label><input type="text" id="pName" class="input-luxe font-black uppercase" required></div>
                        <div><label>E-mail Speler/Ouder (voor notificatie)</label><input type="email" id="pEmail" class="input-luxe" placeholder="player@gmail.com"></div>
                        <div><label>Speler ID</label><input type="text" id="pId" class="input-luxe"></div>
                        <div><label>Foto URL</label><input type="text" id="pPhotoUrl" class="input-luxe" oninput="document.getElementById('pPreviewImg').src=this.value"></div>
                        <div><label>Team</label><select id="pTeam" class="input-luxe" onchange="updateMissingList()"></select></div>
                        <div><label>Periode</label>
                            <select id="pPeriod" class="input-luxe" onchange="checkLockStatus()">
                                <option value="1e seizoenshelft">1e seizoenshelft</option>
                                <option value="2e seizoenshelft">2e seizoenshelft</option>
                                <option value="Eindbeoordeling">Eindbeoordeling</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 section-card">
                    <div class="flex justify-between items-center mb-6">
                        <h3>2. Beoordeling & Feedback</h3>
                        <button type="button" onclick="generateAIFeedback()" class="text-[9px] bg-yellow-500/10 text-yellow-500 px-4 py-2 rounded-full border border-yellow-500/20 font-black uppercase">✨ Smart AI Feedback</button>
                    </div>
                    <div id="skillContainer" class="space-y-4"></div>
                </div>
                <div class="section-card flex flex-col items-center justify-center">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="section-card">
                <h3>3. Persoonlijke Ontwikkeldoelen (POP)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3 bg-white/5 p-4 rounded-2xl border border-white/5">
                        <label class="text-yellow-500">Doel 1</label>
                        <input type="text" id="g1" placeholder="Wat?" class="input-luxe"><textarea id="a1" placeholder="Hoe?" class="input-luxe h-16 text-xs"></textarea><input type="text" id="t1" placeholder="Wanneer?" class="input-luxe text-xs">
                    </div>
                    <div class="space-y-3 bg-white/5 p-4 rounded-2xl border border-white/5">
                        <label class="text-yellow-500">Doel 2</label>
                        <input type="text" id="g2" placeholder="Wat?" class="input-luxe"><textarea id="a2" placeholder="Hoe?" class="input-luxe h-16 text-xs"></textarea><input type="text" id="t2" placeholder="Wanneer?" class="input-luxe text-xs">
                    </div>
                    <div class="space-y-3 bg-white/5 p-4 rounded-2xl border border-white/5">
                        <label class="text-yellow-500">Doel 3</label>
                        <input type="text" id="g3" placeholder="Wat?" class="input-luxe"><textarea id="a3" placeholder="Hoe?" class="input-luxe h-16 text-xs"></textarea><input type="text" id="t3" placeholder="Wanneer?" class="input-luxe text-xs">
                    </div>
                </div>
            </div>

            <div class="save-bar flex flex-col md:flex-row gap-4 items-center justify-center no-print">
                <input type="password" id="ghToken" placeholder="GitHub Access Token" class="input-luxe md:w-80 text-center">
                <button type="submit" id="saveBtn" class="bg-yellow-600 text-black font-black px-12 py-4 rounded-xl uppercase text-xs tracking-widest shadow-2xl hover:bg-yellow-400">Sync, Lock & Mail</button>
                <button type="button" onclick="window.print()" class="bg-white/10 text-white px-8 py-4 rounded-xl uppercase text-xs font-black border border-white/20">Print PDF</button>
            </div>
        </form>
    </div>

    <script type="module">
        import DataProvider from './js/data_provider.js';
        const currentUser = JSON.parse(sessionStorage.getItem('elite_user'));
        if (!currentUser) window.location.href = 'login.html';

        let radarChart, allPlayers = [], currentPlayer = null;

        const skillMap = {
            'Techniek': ['bal', 'pas', 'aan', 'drib', 'schot'],
            'Tactiek': ['posi', 'vrij', 'sam', 'oms'],
            'Fysiek': ['sne', 'uit', 'kra', 'wen'],
            'Mentaal': ['inz', 'mot', 'coa', 'tea']
        };

        const labels = {
            bal: 'Balcontrole', pas: 'Passen', aan: 'Aanname', drib: 'Dribbel', schot: 'Schot',
            posi: 'Positie', vrij: 'Vrijlopen', sam: 'Samenspel', oms: 'Omschakeling',
            sne: 'Snelheid', uit: 'Conditie', kra: 'Kracht', wen: 'Wendbaar',
            inz: 'Inzet', mot: 'Motivatie', coa: 'Coachbaar', tea: 'Team'
        };

        function generateSkillFields() {
            const container = document.getElementById('skillContainer');
            Object.keys(skillMap).forEach(cat => {
                const h = document.createElement('h4');
                h.className = "text-[9px] text-gray-500 uppercase font-black mt-6 mb-3 tracking-widest";
                h.innerText = cat;
                container.appendChild(h);
                skillMap[cat].forEach(key => {
                    const row = document.createElement('div');
                    row.className = "grid grid-cols-1 md:grid-cols-12 gap-4 items-center border-b border-white/5 pb-3";
                    row.innerHTML = `
                        <div class="md:col-span-3 flex justify-between"><label class="mb-0 text-white">${labels[key]}</label><span id="v_${key}" class="text-yellow-500 font-black">3</span></div>
                        <div class="md:col-span-4"><input type="range" id="s_${key}" min="1" max="5" value="3" class="slider-gold rating-input" oninput="v_${key}.innerText=this.value"></div>
                        <div class="md:col-span-5"><input type="text" id="o_${key}" placeholder="Observatie" class="input-luxe py-1 text-[11px]"></div>
                    `;
                    container.appendChild(row);
                });
            });
        }

        async function updateMissingList() {
            const period = document.getElementById('pPeriod').value;
            const selectedTeam = document.getElementById('pTeam').value;
            const playersInTeam = allPlayers.filter(p => p.bio.team === selectedTeam);
            const missing = playersInTeam.filter(p => !p.history || !p.history[period]);
            document.getElementById('missingList').innerText = missing.length > 0 ? missing.map(m => m.bio.name).join(', ') : 'Alles Voltooid ✅';
        }

        window.checkLockStatus = function() {
            if (!currentPlayer) return;
            const period = document.getElementById('pPeriod').value;
            const isLocked = (currentUser.role !== 'admin' && currentPlayer.history && currentPlayer.history[period]);
            document.querySelectorAll('.input-luxe, .slider-gold').forEach(el => {
                if(!['assetSearch', 'pPeriod', 'ghToken', 'pId', 'pTeam', 'pEmail'].includes(el.id)) el.disabled = isLocked;
            });
            updateMissingList();
        }

        window.generateAIFeedback = function() {
            Object.keys(labels).forEach(key => {
                const v = parseInt(document.getElementById('s_'+key).value);
                const o = document.getElementById('o_'+key);
                o.value = v >= 4 ? "Uitstekende uitvoering. Focus behouden." : (v <= 2 ? "Aandachtspunt voor training." : "Gemiddeld niveau, werk aan details.");
            });
        }

        async function saveAndNotify(e) {
            e.preventDefault();
            const token = document.getElementById('ghToken').value;
            const email = document.getElementById('pEmail').value;
            const name = document.getElementById('pName').value;
            const period = document.getElementById('pPeriod').value;

            if(!token) return alert("GitHub Token vereist voor sync.");

            // HIER KOMT DE FETCH LOGICA NAAR GITHUB (Zoals in eerdere versies)
            // Na succesvolle sync:
            alert("✅ Dossier gesynchroniseerd op GitHub.");

            if(email) {
                const subject = encodeURIComponent(`Nieuwe beoordeling Elite Pro: ${name}`);
                const body = encodeURIComponent(`Beste ${name},\n\nJe coach heeft zojuist je beoordeling voor de ${period} afgerond en vastgelegd.\n\nJe kunt je volledige rapport inzien via het dashboard.\n\nMet sportieve groet,\nElite Pro Coach Terminal`);
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }
        }

        async function init() {
            generateSkillFields();
            allPlayers = await DataProvider.getAllPlayers();
            const search = document.getElementById('assetSearch');
            search.innerHTML = '<option value="">-- KIES SPELER --</option>' + 
                allPlayers.map(p => `<option value="${p.id}">${p.bio.name}</option>`).join('');
            const teams = ["JO8-1","JO9-1","JO10-1","JO11-1","JO12-1","JO13-1","JO14-1","JO15-1","JO16-1","JO17-1","JO19-1","Senioren 1"];
            document.getElementById('pTeam').innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('loadBtn').onclick = (e) => {
                e.preventDefault();
                currentPlayer = allPlayers.find(x => x.id === search.value);
                if (currentPlayer) {
                    document.getElementById('pName').value = currentPlayer.bio.name;
                    document.getElementById('pEmail').value = currentPlayer.bio.email || "";
                    document.getElementById('pId').value = currentPlayer.id;
                    document.getElementById('pPhotoUrl').value = currentPlayer.bio.photo;
                    document.getElementById('pPreviewImg').src = currentPlayer.bio.photo;
                    document.getElementById('pTeam').value = currentPlayer.bio.team;
                    checkLockStatus();
                }
            };
            document.getElementById('proForm').onsubmit = saveAndNotify;
        }

        init();
    </script>
</body>
</html>
