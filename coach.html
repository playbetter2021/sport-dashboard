<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Coach Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; --accent: #22c55e; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; padding-bottom: 140px; }
        .input-luxe { background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); padding: 10px; border-radius: 8px; width: 100%; font-size: 13px; outline: none; transition: 0.2s; }
        .input-luxe:focus { border-color: var(--gold); background: rgba(212,175,55,0.1); }
        .section-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 25px; border-radius: 1.5rem; margin-bottom: 2rem; position: relative; }
        label { font-size: 10px; text-transform: uppercase; color: #888; font-weight: bold; margin-bottom: 5px; display: block; }
        h3 { font-size: 11px; color: var(--gold); text-transform: uppercase; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 10px; margin-bottom: 20px; font-weight: 900; }
        .slider-gold { accent-color: var(--gold); cursor: pointer; width: 100%; }
        .preview-photo { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; background: #111; }
        .btn-action { transition: all 0.2s; font-weight: 900; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }
        .btn-action:hover { transform: translateY(-2px); }
        .ai-glow { box-shadow: 0 0 15px rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); }
        .diff-pos { color: #22c55e; }
        .diff-neg { color: #ef4444; }
    </style>
</head>
<body class="p-6 md:p-10">
    <div id="capture-area" class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/5 pb-6 gap-4 no-print">
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-full text-[10px] font-bold uppercase transition border border-white/10">Dashboard</a>
                <h1 class="text-2xl font-black italic text-white uppercase tracking-tighter ml-2">COACH<span class="text-yellow-500">TERMINAL</span></h1>
            </div>
            <div class="flex items-center gap-2 bg-white/5 p-2 rounded-xl border border-white/10">
                <select id="assetSearch" class="bg-transparent outline-none cursor-pointer min-w-[150px] p-2 text-yellow-500 text-xs font-bold"></select>
                <button id="loadBtn" class="bg-yellow-600 text-black px-4 py-2 rounded text-[10px] btn-action">Laden</button>
                <button type="button" onclick="generatePDF()" class="bg-white/10 text-white px-4 py-2 rounded text-[10px] btn-action border border-white/20">Rapport Export</button>
            </div>
        </header>

        <form id="proForm" class="space-y-6">
            <div class="section-card">
                <div class="flex items-center gap-6 mb-8">
                    <img id="pPreviewImg" class="preview-photo" src="https://via.placeholder.com/150/0a0a0a/D4AF37?text=?" alt="Preview">
                    <div>
                        <h3>1. Evaluatie Context</h3>
                        <p id="coachIdent" class="text-[9px] text-gray-500 uppercase font-bold tracking-widest italic"></p>
                        <div id="statusBadge" class="mt-2 text-[10px] font-bold text-green-500 uppercase">Status: Live Bewerking</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2"><label>Naam Speler</label><input type="text" id="pName" class="input-luxe font-bold"></div>
                    <div><label>Team</label><select id="pTeam" class="input-luxe"></select></div>
                    <div>
                        <label>Evaluatie Moment</label>
                        <select id="pPeriod" class="input-luxe border border-yellow-500/30" onchange="window.handlePeriodChange()">
                            <option value="1e seizoenshelft">1e seizoenshelft</option>
                            <option value="2e seizoenshelft">2e seizoenshelft</option>
                            <option value="Eindbeoordeling">Eindbeoordeling</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 section-card ai-glow">
                    <div class="flex justify-between items-center mb-4">
                        <h3>2. Vaardigheden & AI Feedback</h3>
                        <button type="button" onclick="generateAIFeedback()" class="text-[9px] bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded border border-yellow-500/20 italic no-print">✨ Genereer AI Feedback</button>
                    </div>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center border-b border-white/5 pb-4">
                            <div class="flex justify-between"><label>Balcontrole</label><span id="v_bal" class="text-yellow-500 font-bold">3</span></div>
                            <input type="range" id="s_bal" min="1" max="5" value="3" class="slider-gold rating-input" oninput="v_bal.innerText=this.value">
                            <input type="text" id="o_bal" placeholder="AI Feedback..." class="input-luxe text-[11px] ai-field">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center border-b border-white/5 pb-4">
                            <div class="flex justify-between"><label>Passen</label><span id="v_pas" class="text-yellow-500 font-bold">3</span></div>
                            <input type="range" id="s_pas" min="1" max="5" value="3" class="slider-gold rating-input" oninput="v_pas.innerText=this.value">
                            <input type="text" id="o_pas" placeholder="AI Feedback..." class="input-luxe text-[11px] ai-field">
                        </div>
                    </div>
                </div>
                <div class="section-card flex flex-col items-center">
                    <h3>Benchmark vs Team</h3>
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="section-card">
                    <h3>3. Progressie Monitor</h3>
                    <table class="w-full text-[10px]">
                        <thead><tr class="text-gray-500 border-b border-white/10"><th class="text-left py-2">Metric</th><th>Vorige</th><th>Nu</th><th>Groei</th></tr></thead>
                        <tbody id="comparisonTableBody"></tbody>
                    </table>
                </div>
                <div class="section-card">
                    <h3>4. POP Doelen</h3>
                    <div class="space-y-3">
                        <input type="text" id="g1" placeholder="Hoofddoel deze periode" class="input-luxe">
                        <textarea id="pGrowth" class="input-luxe h-20 text-xs" placeholder="Coach analyse..."></textarea>
                    </div>
                </div>
            </div>

            <div class="save-bar flex gap-4 sticky bottom-6 z-50 no-print">
                <input type="password" id="ghToken" placeholder="GitHub Token" class="input-luxe md:w-64 text-center">
                <button type="submit" id="saveBtn" class="bg-yellow-600 text-black font-black px-12 py-4 rounded uppercase text-xs btn-action flex-1 shadow-2xl hover:bg-yellow-400">Synchroniseer Dossier</button>
            </div>
        </form>
    </div>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        const currentUser = JSON.parse(sessionStorage.getItem('elite_user'));
        let radarChart, allPlayers = [], currentPlayer = null;

        // 1. AI FEEDBACK ENGINE
        window.generateAIFeedback = function() {
            const metrics = [
                { id: 'bal', label: 'balcontrole', pos: 'Heel balvast, goed gevoel voor de bal.', neg: 'Focus op eerste aanname en controle onder druk.' },
                { id: 'pas', label: 'passing', pos: 'Strakke passing, ziet de vrije man goed.', neg: 'Werk aan balsnelheid en passing met links.' }
            ];

            metrics.forEach(m => {
                const val = parseInt(document.getElementById('s_' + m.id).value);
                const feedbackField = document.getElementById('o_' + m.id);
                if (val >= 4) feedbackField.value = m.pos;
                else if (val <= 2) feedbackField.value = m.neg;
                else feedbackField.value = "Stabiel niveau, werk aan details voor de volgende stap.";
            });
            alert("✨ AI Feedback gegenereerd op basis van scores.");
        };

        // 2. RADAR & BENCHMARK
        function initRadar() {
            const ctx = document.getElementById('radarChart');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Techniek', 'Tactiek', 'Fysiek', 'Mentaal'],
                    datasets: [
                        { label: 'Speler', data: [3, 3, 3, 3], backgroundColor: 'rgba(212, 175, 55, 0.2)', borderColor: '#D4AF37', borderWidth: 2 },
                        { label: 'Team', data: [3.2, 3.4, 3.1, 3.5], backgroundColor: 'transparent', borderColor: 'rgba(255,255,255,0.2)', borderDash: [5, 5] }
                    ]
                },
                options: { scales: { r: { min: 0, max: 5, grid: { color: 'rgba(255,255,255,0.05)' }, pointLabels: { color: '#666' }, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        // 3. PROGRESSIE & LIVE UPDATES
        function syncData() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            ['bal', 'pas'].forEach(m => {
                const cur = parseInt(document.getElementById('s_' + m).value);
                const prev = currentPlayer?.ratings?.[m] || 3;
                const diff = cur - prev;
                tbody.innerHTML += `<tr><td class="py-2 text-gray-400 uppercase font-bold">${m}</td><td>${prev}</td><td class="text-yellow-500 font-black">${cur}</td><td class="${diff >= 0 ? 'text-green-500' : 'text-red-500'}">${diff > 0 ? '+' : ''}${diff}</td></tr>`;
            });
            radarChart.data.datasets[0].data = [ (parseInt(document.getElementById('s_bal').value)+parseInt(document.getElementById('s_pas').value))/2, 3, 3, 3 ];
            radarChart.update();
        }

        // 4. PDF RAPPORT
        window.generatePDF = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const capture = document.getElementById('capture-area');
            const noPrint = document.querySelectorAll('.no-print');
            noPrint.forEach(el => el.style.display = 'none');

            html2canvas(capture, { backgroundColor: '#0a0a0a', scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
                doc.save(`ElitePro_Rapport_${document.getElementById('pName').value}.pdf`);
                noPrint.forEach(el => el.style.display = '');
            });
        };

        // INITIALISATIE
        async function init() {
            allPlayers = await DataProvider.getAllPlayers();
            initRadar();
            const search = document.getElementById('assetSearch');
            search.innerHTML = '<option value="">-- KIES SPELER --</option>' + allPlayers.map(p => `<option value="${p.id}">${p.bio.name}</option>`).join('');
            
            document.getElementById('loadBtn').onclick = (e) => {
                e.preventDefault();
                currentPlayer = allPlayers.find(x => x.id === search.value);
                if (currentPlayer) {
                    document.getElementById('pName').value = currentPlayer.bio.name;
                    document.getElementById('pPreviewImg').src = currentPlayer.bio.photo;
                    document.getElementById('pTeam').innerHTML = `<option>${currentPlayer.bio.team}</option>`;
                    syncData();
                }
            };
        }

        document.body.addEventListener('input', (e) => { if(e.target.classList.contains('rating-input')) syncData(); });
        init();
    </script>
</body>
</html>
