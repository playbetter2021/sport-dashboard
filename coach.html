<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-app: #09090b; 
            --bg-panel: #18181b; 
            --bg-input: #27272a;
            --border: #3f3f46; 
            --primary: #d4af37; 
            --primary-dim: #a18322;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --success: #10b981;
        }
        
        body { 
            background-color: var(--bg-app); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            height: 100vh; 
            overflow: hidden; /* App feel */
            display: flex;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 280px;
            background-color: #0c0c0e;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            height: 100vh;
            z-index: 10;
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: white;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: var(--primary); }

        .sidebar-section { margin-bottom: 30px; }
        .sidebar-label {
            font-size: 10px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: var(--bg-app);
            position: relative;
        }

        .top-bar {
            position: sticky; top: 0; z-index: 20;
            background: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        /* --- PANELS & CARDS --- */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .panel-title { font-size: 14px; font-weight: 600; color: white; display: flex; align-items: center; gap: 8px; }
        .panel-title::before { content:''; display:block; width:4px; height:14px; background:var(--primary); border-radius:2px;}

        /* --- PLAYER HEADER PROFILE --- */
        .profile-header {
            display: grid; grid-template-columns: 100px 1fr auto; gap: 24px;
            align-items: center;
        }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--bg-panel); outline: 2px solid var(--primary);
            background: #000;
        }
        .profile-info h2 { font-size: 24px; font-weight: 700; color: white; margin-bottom: 4px; }
        .profile-meta { display: flex; gap: 16px; font-size: 13px; color: var(--text-muted); }
        .tag { 
            background: rgba(212, 175, 55, 0.1); color: var(--primary); 
            padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 11px; border: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* --- INPUTS --- */
        .form-group label {
            display: block; font-size: 11px; font-weight: 500; color: var(--text-muted); margin-bottom: 6px;
        }
        .input-std {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 10px 12px; border-radius: 6px; font-size: 13px;
            transition: all 0.2s; outline: none;
        }
        .input-std:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1); }
        .input-std:read-only { background: transparent; border: 1px solid transparent; color: var(--text-main); font-weight: 600; padding-left: 0; }
        .input-std:disabled { opacity: 0.5; cursor: not-allowed; }
        textarea.input-std { resize: none; line-height: 1.5; }

        /* --- SLIDERS & RADAR --- */
        .skill-row {
            display: grid; grid-template-columns: 120px 40px 1fr 1fr; gap: 16px; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .skill-row:last-child { border-bottom: none; }
        
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: var(--border); border-radius: 2px;
        }
        .score-badge {
            background: var(--bg-input); color: var(--primary); font-weight: 700;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; border: 1px solid var(--border); font-size: 13px;
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            padding: 10px 20px; border-radius: 8px; font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: 0.2s; border: none;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: #e5c150; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-sm { padding: 6px 12px; font-size: 10px; }

        /* --- STATUS DOTS & MONITOR --- */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background: var(--success); box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
        .dot-orange { background: orange; box-shadow: 0 0 8px rgba(255, 165, 0, 0.4); }
        .dot-red { background: var(--danger); box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
        
        .monitor-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; 
            font-size: 12px; color: var(--text-muted); cursor: pointer;
        }
        .monitor-item:hover { background: rgba(255,255,255,0.05); color: white; }

        /* --- PRINT CSS (A4) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { 
                background: white !important; color: black !important; 
                height: auto; overflow: visible; display: block;
            }
            aside, .no-print, .top-bar, .ai-btn { display: none !important; }
            main { margin: 0; padding: 0; }
            .content-container { max-width: 100%; padding: 15mm; }
            
            .panel { 
                border: 1px solid #ddd !important; 
                background: white !important; color: black !important;
                box-shadow: none !important; margin-bottom: 20px; page-break-inside: avoid;
            }
            .panel-title { color: black !important; }
            .profile-info h2 { color: black !important; }
            .input-std { color: black !important; border: none !important; padding: 0 !important; background: transparent !important; }
            .tag { border: 1px solid #000; color: #000; background: transparent; }
            
            /* Radar Print fix */
            .radar-box { height: 300px !important; width: 300px !important; margin: 0 auto; }
            canvas { max-width: 100% !important; }
            
            /* Sliders verbergen, scores tonen */
            input[type=range] { display: none; }
            .score-badge { border: 1px solid #000; color: #000; background: transparent; }
            .skill-row { border-bottom: 1px solid #eee; grid-template-columns: 150px 40px 1fr; }
            
            /* Forceer graphics */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

    <aside class="no-print">
        <div class="brand">
            <div class="w-8 h-8 bg-yellow-600 rounded flex items-center justify-center text-black font-black text-xs">EP</div>
            <div>ELITE<span>PRO</span></div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-label">Selectie</div>
            <select id="assetSearch" class="input-std mb-2" style="background: var(--bg-app);">
                <option value="">Zoek speler...</option>
            </select>
            <button id="loadBtn" class="btn btn-primary w-full btn-sm">Dossier Laden</button>
        </div>

        <div class="sidebar-section" style="flex: 1; overflow-y: auto;">
            <div class="sidebar-label">Team Monitor</div>
            <div id="tcTeamList">
                </div>
        </div>

        <div class="sidebar-section mt-auto">
            <div class="sidebar-label">Systeem</div>
            <input type="password" id="ghToken" placeholder="GitHub Token" class="input-std mb-2 text-xs">
            <div class="text-[10px] text-gray-500">Versie 2.4.0 (Ent)</div>
        </div>
    </aside>

    <main>
        <div class="top-bar no-print">
            <div class="flex items-center gap-4">
                <select id="pPeriod" class="input-std" style="width: 200px;" onchange="loadPeriodData()">
                    <option value="1e seizoenshelft">1e seizoenshelft</option>
                    <option value="2e seizoenshelft">2e seizoenshelft</option>
                    <option value="Eindbeoordeling">Eindbeoordeling</option>
                </select>
            </div>
            <div class="flex items-center gap-3">
                <button type="button" onclick="savePlayer('draft')" id="btnDraft" class="btn btn-ghost">Concept Opslaan</button>
                <button type="button" onclick="if(confirm('Weet u het zeker? Hierna is het dossier vergrendeld.')) savePlayer('locked')" id="btnFinal" class="btn btn-danger">üîí Definitief</button>
                <button type="button" onclick="window.print()" class="btn btn-primary">üñ®Ô∏è PDF</button>
            </div>
        </div>

        <div class="content-container">
            <form id="proForm">
                
                <div class="panel">
                    <div id="lockBadge" class="hidden bg-red-500/10 text-red-500 border border-red-500/20 px-3 py-1 rounded text-xs font-bold w-fit mb-4">üîí DOSSIER VERGRENDELD</div>
                    
                    <div class="profile-header">
                        <img id="pPreviewImg" class="profile-avatar" src="https://via.placeholder.com/150" alt="Profile">
                        
                        <div class="profile-info">
                            <h2 id="dispName">SELECTEER SPELER</h2>
                            <div class="profile-meta">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">Team:</span>
                                    <span class="tag" id="dispTeam">--</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">Positie:</span>
                                    <span class="text-white font-medium" id="dispRole">--</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">Rugnummer:</span>
                                    <span class="text-white font-medium" id="dispNumber">--</span>
                                </div>
                            </div>
                            
                            <div class="hidden">
                                <input type="text" id="pName" readonly>
                                <input type="number" id="pNumber" readonly>
                                <input type="text" id="pTeam" readonly>
                                <input type="text" id="pPos" readonly>
                                <input type="text" id="pPhotoUrl" readonly>
                                <input type="text" id="pEmail" readonly>
                                <input type="text" id="pId" readonly>
                            </div>
                        </div>

                        <div class="text-right">
                             <div class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-1">Performance Score</div>
                             <div id="avgScore" class="text-4xl font-black text-white">0.0</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div id="cardAssessment" class="lg:col-span-2 panel">
                        <div class="panel-header">
                            <div class="panel-title">Technische & Tactische Analyse</div>
                            <button type="button" onclick="fillAI()" class="btn btn-ghost btn-sm ai-btn">‚ú® AI Auto-Fill</button>
                        </div>
                        <div id="skillContainer">
                            </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div class="panel flex flex-col items-center justify-center">
                            <div class="panel-title w-full mb-4">Competentie Radar</div>
                            <div class="radar-box relative w-full aspect-square max-w-[300px]">
                                <canvas id="liveRadar"></canvas>
                            </div>
                        </div>

                        <div id="cardPop" class="panel flex-1">
                            <div class="panel-header"><div class="panel-title">Ontwikkelplan (POP)</div></div>
                            <div class="space-y-4">
                                <div class="form-group">
                                    <label>Doelstelling</label>
                                    <textarea id="g1" class="input-std" rows="3" placeholder="Hoofddoel..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Actieplan</label>
                                    <textarea id="a1" class="input-std" rows="3" placeholder="Actiepunten..."></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="form-group">
                                        <label>Sterktes</label>
                                        <textarea id="pStrengths" class="input-std" rows="2"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Verbeterpunten</label>
                                        <textarea id="pGrowth" class="input-std" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        let radarChart, allPlayers = [], currentPlayer = null;
        const skillMap = { 'Techniek': ['bal','pas','aan','drib','schot'], 'Tactiek': ['posi','vrij','sam','oms'], 'Fysiek': ['sne','uit','kra','wen'], 'Mentaal': ['inz','mot','coa','tea'] };
        const labels = { bal:'Balcontrole', pas:'Passen', aan:'Aanname', drib:'Dribbel', schot:'Schot', posi:'Positie', vrij:'Vrijlopen', sam:'Samenspel', oms:'Omschakeling', sne:'Snelheid', uit:'Conditie', kra:'Kracht', wen:'Wendbaar', inz:'Inzet', mot:'Motivatie', coa:'Coachbaar', tea:'Team' };
        
        if(localStorage.getItem('gh_token')) document.getElementById('ghToken').value = localStorage.getItem('gh_token');

        // UI Logic
        function lockUI() {
            document.getElementById('lockBadge').classList.remove('hidden');
            const formElements = document.querySelectorAll('#cardAssessment input, #cardAssessment button.ai-btn, #cardPop textarea');
            formElements.forEach(el => el.disabled = true);
            
            const btnDraft = document.getElementById('btnDraft');
            const btnFinal = document.getElementById('btnFinal');
            
            btnDraft.style.display = 'none';
            btnFinal.innerText = "Grendel actief";
            btnFinal.disabled = true;
            btnFinal.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function unlockUI() {
            document.getElementById('lockBadge').classList.add('hidden');
            const formElements = document.querySelectorAll('#cardAssessment input, #cardAssessment button.ai-btn, #cardPop textarea');
            formElements.forEach(el => el.disabled = false);
            
            const btnDraft = document.getElementById('btnDraft');
            const btnFinal = document.getElementById('btnFinal');
            
            btnDraft.style.display = 'inline-flex';
            btnFinal.innerText = "üîí Definitief";
            btnFinal.disabled = false;
            btnFinal.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        window.loadPeriodData = () => {
            if(!currentPlayer) return;
            const period = document.getElementById('pPeriod').value;
            const history = currentPlayer.history?.[period];

            if(history) {
                Object.keys(labels).forEach(k => {
                    document.getElementById('s_'+k).value = history.ratings?.[k] || 5;
                    document.getElementById('v_'+k).innerText = history.ratings?.[k] || 5;
                    document.getElementById('o_'+k).value = history.comments?.[k] || "";
                });
                document.getElementById('g1').value = history.pop?.goal || "";
                document.getElementById('a1').value = history.pop?.action || "";
                document.getElementById('pStrengths').value = history.pop?.strengths || "";
                document.getElementById('pGrowth').value = history.pop?.growth || "";
                if(history.status === 'locked') lockUI(); else unlockUI();
            } else {
                // Reset fields
                document.querySelectorAll('#skillContainer input[type=range]').forEach(i => i.value = 5);
                document.querySelectorAll('#skillContainer input[type=text]').forEach(i => i.value = "");
                document.querySelectorAll('.score-badge').forEach(s => s.innerText = "5");
                document.querySelectorAll('#cardPop textarea').forEach(t => t.value = "");
                unlockUI();
            }
            window.updateRadar();
        };

        window.refreshTCMonitor = () => {
            const period = document.getElementById('pPeriod').value;
            const container = document.getElementById('tcTeamList');
            container.innerHTML = "";
            const teams = [...new Set(allPlayers.map(p => p.bio.team))].sort();
            
            teams.forEach(team => {
                const teamPlayers = allPlayers.filter(p => p.bio.team === team);
                let html = `<div class="mb-4"><div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">${team}</div>`;
                
                teamPlayers.forEach(p => {
                    const status = p.history?.[period]?.status || 'missing';
                    let dotClass = status === 'locked' ? 'dot-green' : (status === 'draft' ? 'dot-orange' : 'dot-red');
                    html += `<div class="monitor-item" onclick="document.getElementById('assetSearch').value='${p.id}'; document.getElementById('loadBtn').click();">
                                <span>${p.bio.name}</span>
                                <span class="status-dot ${dotClass}"></span>
                             </div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
        };

        window.savePlayer = async (status) => {
            const token = document.getElementById('ghToken').value;
            if(!token) return alert("GitHub Token vereist!");
            if(!currentPlayer) return alert("Selecteer eerst een speler!");
            
            const period = document.getElementById('pPeriod').value;
            const ratings = {}; const comments = {};
            Object.keys(labels).forEach(k => {
                ratings[k] = parseInt(document.getElementById('s_'+k).value);
                comments[k] = document.getElementById('o_'+k).value;
            });

            const playerData = { ...currentPlayer };
            if(!playerData.history) playerData.history = {};
            
            playerData.history[period] = {
                status: status,
                lastUpdated: new Date().toISOString(),
                ratings: ratings,
                comments: comments,
                pop: {
                    goal: document.getElementById('g1').value,
                    action: document.getElementById('a1').value,
                    strengths: document.getElementById('pStrengths').value,
                    growth: document.getElementById('pGrowth').value
                }
            };

            try {
                await DataProvider.updatePlayer(playerData, token);
                alert(status === 'locked' ? "‚úÖ Dossier definitief vergrendeld!" : "üíæ Concept opgeslagen.");
                allPlayers = await DataProvider.getAllPlayers(); 
                currentPlayer = allPlayers.find(p => p.id === playerData.id);
                loadPeriodData();
                refreshTCMonitor();
            } catch(err) { alert("‚ùå Fout: " + err.message); }
        };

        window.fillAI = () => {
            Object.keys(labels).forEach(k => {
                const val = parseInt(document.getElementById('s_'+k).value);
                const field = document.getElementById('o_'+k);
                if(val >= 8) field.value = "Elite performance. Handhaven.";
                else if(val <= 5) field.value = "Aandachtspunt voor ontwikkeling.";
                else field.value = "Stabiel niveau, focus op details.";
            });
        };

        window.updateRadar = () => {
            const values = [];
            let total = 0, count = 0;
            Object.values(skillMap).forEach(keys => {
                const avg = keys.reduce((a, b) => {
                    const v = parseInt(document.getElementById('s_'+b).value || 5);
                    total += v; count++;
                    return a + v;
                }, 0) / keys.length;
                values.push(avg);
            });
            radarChart.data.datasets[0].data = values;
            radarChart.update();
            document.getElementById('avgScore').innerText = (total / count).toFixed(1);
        };

        async function init() {
            // Build Skills UI
            const container = document.getElementById('skillContainer');
            Object.keys(skillMap).forEach(cat => {
                container.innerHTML += `<div class="text-xs font-bold text-yellow-600 uppercase tracking-widest mt-6 mb-3 border-b border-white/5 pb-1">${cat}</div>`;
                skillMap[cat].forEach(key => {
                    container.innerHTML += `
                        <div class="skill-row">
                            <label class="text-gray-300 font-medium text-xs">${labels[key]}</label>
                            <span id="v_${key}" class="score-badge">5</span>
                            <input type="range" id="s_${key}" min="1" max="10" value="5" oninput="v_${key}.innerText=this.value; updateRadar();">
                            <input type="text" id="o_${key}" placeholder="Notitie..." class="input-std text-xs">
                        </div>`;
                });
            });

            // Init Data
            allPlayers = await DataProvider.getAllPlayers();
            document.getElementById('assetSearch').innerHTML = '<option value="">Zoek speler...</option>' + allPlayers.map(p => `<option value="${p.id}">${p.bio.name}</option>`).join('');

            // Init Chart
            const ctx = document.getElementById('liveRadar').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: { labels: ['Techniek', 'Tactiek', 'Fysiek', 'Mentaal'], datasets: [{ data: [5,5,5,5], backgroundColor: 'rgba(212, 175, 55, 0.2)', borderColor: '#D4AF37', borderWidth: 2, pointRadius: 3, pointBackgroundColor: '#fff' }] },
                options: { 
                    scales: { r: { min: 0, max: 10, ticks: { display: false }, grid: { color: '#333' }, angleLines: { color: '#333' }, pointLabels: { color: '#888', font: { size: 10, weight: 'bold' } } } }, 
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });

            // Handlers
            document.getElementById('loadBtn').onclick = (e) => {
                const pId = document.getElementById('assetSearch').value;
                if(!pId) return;
                
                const p = allPlayers.find(x => x.id === pId);
                if(p) {
                    currentPlayer = p;
                    // Populate Hidden & UI fields
                    document.getElementById('pName').value = p.bio.name;
                    document.getElementById('pId').value = p.id;
                    document.getElementById('pNumber').value = p.bio.number;
                    document.getElementById('pTeam').value = p.bio.team;
                    document.getElementById('pPos').value = p.bio.role;
                    document.getElementById('pPhotoUrl').value = p.bio.photo;
                    document.getElementById('pEmail').value = p.bio.email || "";

                    // Update UI Header
                    document.getElementById('dispName').innerText = p.bio.name;
                    document.getElementById('dispNumber').innerText = `#${p.bio.number}`;
                    document.getElementById('dispTeam').innerText = p.bio.team;
                    document.getElementById('dispRole').innerText = p.bio.role;
                    document.getElementById('pPreviewImg').src = p.bio.photo || "https://via.placeholder.com/150";
                    
                    loadPeriodData();
                }
            };
            
            refreshTCMonitor();
        }
        init();
    </script>
</body>
</html>
