<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Elite Pro | Intelligence Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --gold: #D4AF37; --obsidian: #0a0a0a; }
        body { background-color: var(--obsidian); color: #e5e5e5; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F9E272 50%, #B8860B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 1.5rem; }
        .skill-bar { height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden; }
        .skill-fill { height: 100%; background: linear-gradient(90deg, #B8860B, #D4AF37); transition: width 1.5s cubic-bezier(0.1, 0, 0, 1); }
        .status-badge { background: rgba(212, 175, 55, 0.1); border: 1px solid var(--gold); color: var(--gold); padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .welcome-animate { animation: fadeInScale 0.8s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1600px] mx-auto">
     <header class="flex flex-col lg:flex-row justify-between items-center mb-10 border-b border-white/5 pb-6 gap-4">
    <div>
        <h1 class="text-4xl font-black italic gold-gradient uppercase tracking-tighter">Elite<span class="text-white not-italic">Intelligence</span></h1>
        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-[0.3em]">Season 2025-2026 | Mission Control</p>
    </div>
    <div class="flex flex-wrap justify-center gap-3">
        <a href="overview.html" class="px-5 py-2.5 bg-white/5 border border-white/20 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Team Hub</a>
        <a href="planner.html" class="px-5 py-2.5 bg-white/5 border border-white/20 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">Squad Planner</a>
        <a href="coach.html" class="px-5 py-2.5 bg-yellow-600/10 border border-yellow-600/30 rounded-full text-[10px] font-bold uppercase text-yellow-500 hover:bg-yellow-600/20 transition">Coach Terminal</a>
        
        <div id="adminLink" class="hidden">
            <a href="admin_panel.html" class="px-5 py-2.5 border border-purple-500/30 text-purple-400 rounded-full text-[10px] font-bold uppercase hover:bg-purple-500/10 transition">Admin Panel</a>
        </div>

        <button onclick="sessionStorage.clear(); window.location.href='login.html';" class="px-5 py-2.5 bg-red-500/10 border border-red-500/20 rounded-full text-[10px] font-bold uppercase text-red-500 hover:bg-red-500/20 transition">Logout</button>
        <select id="playerSelector" class="bg-black border border-yellow-700/50 text-yellow-500 py-2.5 px-8 rounded-full text-xs font-bold outline-none cursor-pointer shadow-2xl"></select>
    </div>
</header></header>

        <div id="welcomeScreen" class="welcome-animate flex flex-col items-center justify-center min-h-[60vh] text-center">
            <div class="glass-card p-16 max-w-4xl border-2 border-yellow-600/20 shadow-[0_0_50px_rgba(212,175,55,0.05)]">
                <h2 class="text-6xl font-black italic text-white uppercase mb-6 tracking-tighter">Ready for <span class="text-yellow-500 text-7xl block">Analysis?</span></h2>
                <p class="text-gray-400 text-lg leading-relaxed mb-12 max-w-2xl mx-auto">
                    Selecteer een asset in de terminal om de volledige 360Â° dataset, groeitrends en de persoonlijke <span class="text-white font-bold italic">Zomer-Roadmap 2026</span> te ontsluiten.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 border-t border-white/10 pt-10">
                    <div class="space-y-1">
                        <p class="text-4xl font-black text-white" id="stat-total">0</p>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Geregistreerd</p>
                    </div>
                    <div class="space-y-1 border-x border-white/10">
                        <p class="text-4xl font-black text-yellow-500" id="stat-avg">0%</p>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Gem. Elite Index</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-4xl font-black text-green-500" id="stat-growth">0</p>
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Grootste Stijger</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="playerDossier" class="hidden welcome-animate">
            <div id="captureArea" class="bg-[#0a0a0a] p-8 rounded-[3rem] border border-white/10 shadow-2xl">
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                    
                    <div class="xl:col-span-3 space-y-6">
                        <div class="glass-card overflow-hidden relative group">
                            <img id="pPhoto" class="w-full h-[500px] object-cover bg-neutral-900 transition duration-700 group-hover:scale-110" src="" crossorigin="anonymous">
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent"></div>
                            <div class="absolute bottom-8 left-8">
                                <div id="pAllocation" class="status-badge mb-4 inline-block">Berekent...</div>
                                <h2 id="pName" class="text-5xl font-black uppercase italic text-white leading-none tracking-tighter"></h2>
                                <p id="pMeta" class="text-gray-400 text-[10px] font-bold mt-3 uppercase tracking-[0.3em]"></p>
                            </div>
                        </div>
                        
                        <div class="glass-card p-6">
                            <h3 class="text-[10px] font-black text-gray-500 uppercase mb-6 tracking-widest text-center">Groeicurve</h3>
                            <canvas id="trendChart" height="200"></canvas>
                        </div>

                        <div class="glass-card p-8 flex flex-col items-center">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <div class="xl:col-span-9 space-y-6">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="glass-card p-8 text-center border-b-4 border-yellow-600">
                                <p class="text-[10px] text-gray-500 uppercase font-black mb-2">Elite Index</p>
                                <div id="finalScore" class="text-6xl font-black text-white italic">0</div>
                            </div>
                            <div class="glass-card p-8 text-center border-b-4 border-blue-500">
                                <p class="text-[10px] text-gray-500 uppercase font-black mb-2">Opkomst</p>
                                <div id="attScore" class="text-6xl font-black text-white italic">0%</div>
                            </div>
                            <div class="glass-card p-8 text-center border-b-4 border-green-500">
                                <p class="text-[10px] text-gray-500 uppercase font-black mb-2">Minuten</p>
                                <div id="minScore" class="text-6xl font-black text-white italic">0</div>
                            </div>
                            <div class="glass-card p-8 text-center border-b-4 border-purple-500">
                                <p class="text-[10px] text-gray-500 uppercase font-black mb-2">Progressie</p>
                                <div id="growthVal" class="text-6xl font-black text-white italic">0</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-card p-8"><h4 class="text-xs font-black text-yellow-500 uppercase mb-8 border-l-4 border-yellow-500 pl-4">Technical (65%)</h4><div id="techGrid" class="space-y-5"></div></div>
                            <div class="glass-card p-8"><h4 class="text-xs font-black text-blue-500 uppercase mb-8 border-l-4 border-blue-500 pl-4">Tactical / Physical</h4><div id="physGrid" class="space-y-5"></div></div>
                            <div class="glass-card p-8"><h4 class="text-xs font-black text-purple-500 uppercase mb-8 border-l-4 border-purple-500 pl-4">Mental / Team</h4><div id="mentGrid" class="space-y-5"></div></div>
                        </div>

                        <div class="glass-card p-10 border-2 border-yellow-600/30 bg-gradient-to-br from-yellow-600/10 via-transparent to-transparent relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-5 font-black text-9xl italic uppercase pointer-events-none tracking-tighter">ROADMAP</div>
                            <h3 class="text-2xl font-black text-white uppercase mb-8 italic tracking-tighter">Zomer-Roadmap 2026 <span class="text-yellow-500 underline decoration-1 underline-offset-8">Focus Plan</span></h3>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-center">
                                <div class="lg:col-span-4 bg-black/60 p-8 rounded-3xl border border-white/10 shadow-inner">
                                    <label class="text-[10px] font-black text-yellow-500 uppercase tracking-[0.2em] mb-4 block">Primary Skill Target</label>
                                    <p id="focusSkill" class="text-4xl font-black text-white uppercase italic tracking-tighter">-</p>
                                    <div class="mt-6 pt-6 border-t border-white/10 flex items-center justify-between">
                                        <span class="text-xs text-gray-500 font-bold uppercase">Prognose Index</span>
                                        <span id="targetProg" class="text-2xl font-black text-green-500 tracking-tighter">0%</span>
                                    </div>
                                </div>
                                <div class="lg:col-span-8">
                                    <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4 block underline">Zomer Strategie & Opdracht</label>
                                    <p id="summerText" class="text-base text-gray-300 italic leading-relaxed font-light"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-12 flex flex-col md:flex-row justify-center items-center gap-8 no-print">
                <button id="downloadBtn" class="bg-gradient-to-r from-yellow-600 to-yellow-400 text-black font-black px-20 py-6 rounded-full text-[11px] uppercase tracking-[0.3em] shadow-[0_20px_50px_rgba(212,175,55,0.3)] transform transition hover:scale-105 active:scale-95">Download Full Dossier 2026</button>
            </div>
        </div>
    </div>

    <script type="module">
        import DataProvider from './js/data_provider.js';

        // 1. AUTH GUARD: Check of er is ingelogd
        const sessionUser = sessionStorage.getItem('elite_user');
        if (!sessionUser) {
            window.location.href = 'login.html';
        }
        const currentUser = JSON.parse(sessionUser);

        let chartRadar = null, chartTrend = null;
        let filteredPlayers = [];

        const calcIndex = (p) => {
            if(!p.obj || !p.ratings) return 0;
            const obj = Math.round((p.obj.attendance * 0.4) + ((p.obj.minutes / 1500) * 100 * 0.6));
            const coach = Math.round((Object.values(p.ratings).reduce((a,b)=>parseInt(a)+parseInt(b),0)/(Object.keys(p.ratings).length*5))*100);
            const tech = p.stats?.Techniek || 50;
            return Math.round((obj * 0.65) + (tech * 0.20) + (coach * 0.15));
        };

        async function init() {
            const allPlayers = await DataProvider.getAllPlayers();
            if(!allPlayers.length) return;

            // 2. FILTEREN OP ROL: Alleen de teams van deze coach
            if (currentUser.role === 'admin' || currentUser.teams.includes("ALL")) {
                filteredPlayers = allPlayers;
            } else {
                filteredPlayers = allPlayers.filter(p => currentUser.teams.includes(p.bio.team));
            }

            // Global Stats for Splash (gebaseerd op gefilterde lijst)
            document.getElementById('stat-total').innerText = filteredPlayers.length;
            const avg = filteredPlayers.length > 0 ? Math.round(filteredPlayers.reduce((acc, p) => acc + calcIndex(p), 0) / filteredPlayers.length) : 0;
            document.getElementById('stat-avg').innerText = avg + "%";

            // Find Top Grower
            let topGrower = { name: "-", val: 0 };
            filteredPlayers.forEach(p => {
                if(p.history && p.history["1e seizoenshelft"]) {
                    const diff = calcIndex(p) - calcIndex({...p, ...p.history["1e seizoenshelft"], ratings: p.history["1e seizoenshelft"].ratings});
                    if(diff > topGrower.val) topGrower = { name: p.bio.name, val: diff };
                }
            });
            document.getElementById('stat-growth').innerText = topGrower.name.split(' ')[0];

            // Selector
            const selector = document.getElementById('playerSelector');
            selector.innerHTML = '<option value="">--Players--</option>' + 
                filteredPlayers.map(p => `<option value="${p.id}">${p.bio.name}</option>`).join('');

            selector.addEventListener('change', e => {
                if(e.target.value) {
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('playerDossier').classList.remove('hidden');
                    update(e.target.value);
                }
            });
        }

        const update = (id) => {
            const p = filteredPlayers.find(x => x.id === id);
            if(!p) return;

            document.getElementById('pName').innerText = p.bio.name;
            document.getElementById('pPhoto').src = p.bio.photo;
            document.getElementById('pMeta').innerText = `${p.bio.team} | ${p.bio.role} | SEASON REVIEW`;
            
            const idx = calcIndex(p);
            document.getElementById('finalScore').innerText = idx;
            document.getElementById('attScore').innerText = (p.obj?.attendance || 0) + "%";
            document.getElementById('minScore').innerText = p.obj?.minutes || 0;
            document.getElementById('pAllocation').innerText = idx > 65 ? "Advies: Selectie" : "Advies: Recreatie";

            if(p.history && p.history["1e seizoenshelft"]) {
                const start = calcIndex({...p, ...p.history["1e seizoenshelft"], ratings: p.history["1e seizoenshelft"].ratings});
                const diff = idx - start;
                document.getElementById('growthVal').innerText = (diff >= 0 ? "+" : "") + diff;
            }

            const bar = (l, v) => `<div class="space-y-2"><div class="flex justify-between text-[9px] font-black uppercase"><span class="text-gray-500">${l}</span><span class="text-white">${v}/5</span></div><div class="skill-bar"><div class="skill-fill" style="width:${(v/5)*100}%"></div></div></div>`;
            const r = p.ratings || {};
            document.getElementById('techGrid').innerHTML = bar("Balcontrole", r.bal) + bar("Passing", r.pas) + bar("Aanname", r.aan) + bar("Dribbel", r.drib) + bar("Schieten", r.schot);
            document.getElementById('physGrid').innerHTML = bar("Snelheid", r.sne) + bar("Kracht", r.kra) + bar("Uithouding", r.uit) + bar("Wendbaarheid", r.wen) + bar("Tactiek", r.posi);
            document.getElementById('mentGrid').innerHTML = bar("Inzet", r.inz) + bar("Focus", r.mot) + bar("Coaching", r.coa) + bar("Teamgedrag", r.tea);

            const sm = { bal:"Balcontrole", pas:"Passing", aan:"Aanname", schot:"Schieten", sne:"Explosiviteit", uit:"Conditie", posi:"Spelinzicht" };
            let lowK = "bal", lowV = 6;
            ['bal','pas','aan','schot','sne','uit','posi'].forEach(k => { if(r[k] < lowV) { lowV = r[k]; lowK = k; } });
            
            document.getElementById('focusSkill').innerText = sm[lowK];
            document.getElementById('targetProg').innerText = (idx + 7) + "%";
            document.getElementById('summerText').innerText = `Gezien je huidige performance op ${sm[lowK]} (${lowV}/5) ligt hier de sleutel voor seizoen 2026. Door specifiek op dit onderdeel te trainen in de zomerstop, voorspelt onze data een stijging van je Elite Index naar ${idx + 7}%. Focus op herhaling en intensiteit.`;

            renderRadar(p);
            renderTrend(p);
        };

        const renderRadar = (p) => {
            const ctx = document.getElementById('radarChart');
            if(chartRadar) chartRadar.destroy();
            chartRadar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Techniek', 'Tactiek', 'Fysiek', 'Mentaal'],
                    datasets: [{ data: Object.values(p.stats), borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.2)', borderWidth: 3, pointRadius: 0 }]
                },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: {display:false}, grid:{color:'rgba(255,255,255,0.05)'}, angleLines:{color:'rgba(255,255,255,0.1)'} } }, plugins: { legend: { display: false } } }
            });
        };

        const renderTrend = (p) => {
            const ctx = document.getElementById('trendChart');
            if(chartTrend) chartTrend.destroy();
            const lbls = ["Start", "Winter", "Eind"];
            const data = ["1e seizoenshelft", "2e seizoenshelft", "Eindbeoordeling"].map(l => p.history?.[l] ? calcIndex({...p, ...p.history[l], ratings: p.history[l].ratings}) : null);
            chartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: lbls,
                    datasets: [{ data: data, borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#FFF' }]
                },
                options: { scales: { y: { suggestedMin: 40, suggestedMax: 100, grid: {color:'#111'}, ticks:{color:'#555'} }, x: { grid: {display:false}, ticks:{color:'#888'} } }, plugins: { legend: { display: false } } }
            });
        };

        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const area = document.getElementById('captureArea');
            const canvas = await html2canvas(area, { backgroundColor: '#0a0a0a', scale: 2, useCORS: true });
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
            pdf.save(`Elite_Full_Report_2026.pdf`);
        });

        init();
    </script>
</body>
</html>
